<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="YOLO v5-4.0 版本源码解读">
<meta property="og:type" content="article">
<meta property="og:title" content="YOLO V5-4.0源码解读">
<meta property="og:url" content="http://example.com/YOLO-V5/YOLO-V5-4-0%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="TLDX&#39;s blog">
<meta property="og:description" content="YOLO v5-4.0 版本源码解读">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-10-24T06:32:45.000Z">
<meta property="article:modified_time" content="2021-11-19T08:26:08.880Z">
<meta property="article:author" content="TLDX">
<meta property="article:tag" content="YOLO V5-4.0">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/YOLO-V5/YOLO-V5-4-0%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>YOLO V5-4.0源码解读 | TLDX's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">TLDX's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">a waver</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">7</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/YOLO-V5/YOLO-V5-4-0%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="TLDX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TLDX's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          YOLO V5-4.0源码解读
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-24 14:32:45" itemprop="dateCreated datePublished" datetime="2021-10-24T14:32:45+08:00">2021-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-11-19 16:26:08" itemprop="dateModified" datetime="2021-11-19T16:26:08+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/YOLO-V5/" itemprop="url" rel="index"><span itemprop="name">YOLO V5</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/YOLO-V5/YOLO-V5-4-0%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/YOLO-V5/YOLO-V5-4-0%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>50 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <center>
YOLO v5-4.0 版本源码解读
</center>
<span id="more"></span>
<p>目前yolov5已经更新迭代了多个版本，最新版本已经到了<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/tree/v6.0">YOLOv5-6.0</a>，并且处于一直维护状态。本博客主要是对<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/tree/v4.0">YOLOv5-4.0</a>的项目代码文件做解读。</p>
<h4 id="项目结构">项目结构</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">yolov5-<span class="number">4.0</span></span><br><span class="line">├─ data</span><br><span class="line">│  ├─ images               <span class="comment"># 存放待处理图片</span></span><br><span class="line">│  ├─ coco.yaml            <span class="comment"># coco数据集配置文件</span></span><br><span class="line">│  ├─ coco128.yaml         <span class="comment"># coco128数据集配置文件</span></span><br><span class="line">│  ├─ hyp.finetune.yaml    <span class="comment"># 模型微调超参数配置文件</span></span><br><span class="line">│  ├─ hyp.scratch.yaml     <span class="comment"># 模型从头训练超参数配置文件</span></span><br><span class="line">│  └─ voc.yaml             <span class="comment"># voc数据集配置文件</span></span><br><span class="line">├─ models</span><br><span class="line">│  ├─ common.py            <span class="comment"># 模型组件定义代码</span></span><br><span class="line">│  ├─ experimental.py      <span class="comment"># 实验性质代码</span></span><br><span class="line">│  ├─ export.py            <span class="comment"># 模型导出脚本</span></span><br><span class="line">│  ├─ hub</span><br><span class="line">│  ├─ yolo.py              <span class="comment"># Detect 以及 Model 构建</span></span><br><span class="line">│  ├─ yolov5l.yaml         <span class="comment"># yolov5l 模型配置文件</span></span><br><span class="line">│  ├─ yolov5m.yaml         <span class="comment"># yolov5m 模型配置文件</span></span><br><span class="line">│  ├─ yolov5s.yaml         <span class="comment"># yolov5s 模型配置文件</span></span><br><span class="line">│  ├─ yolov5x.yaml         <span class="comment"># yolov5x 模型配置文件</span></span><br><span class="line">│  └─ __init__.py</span><br><span class="line">├─ runs</span><br><span class="line">│  ├─ detect               <span class="comment"># 输出推断结果</span></span><br><span class="line">│  ├─ test                 <span class="comment"># 测试结果</span></span><br><span class="line">│  └─ train                <span class="comment"># 训练结果</span></span><br><span class="line">├─ detect.py               <span class="comment"># 前向推理代码</span></span><br><span class="line">├─ test.py                 <span class="comment"># 测试模型代码</span></span><br><span class="line">├─ train.py                <span class="comment"># 训练网络代码</span></span><br><span class="line">├─ tutorial.ipynb          <span class="comment"># 例程</span></span><br><span class="line">├─ requirements.txt        <span class="comment"># 环境所需的安装包</span></span><br><span class="line">├─ hubconf.py</span><br><span class="line">├─ LICENSE</span><br><span class="line">├─ Dockerfile</span><br><span class="line">├─ utils</span><br><span class="line">│  ├─ activations.py       <span class="comment"># 激活函数</span></span><br><span class="line">│  ├─ autoanchor.py        <span class="comment"># 自动计算锚框</span></span><br><span class="line">│  ├─ datasets.py          <span class="comment"># 定义数据集类并加载数据集</span></span><br><span class="line">│  ├─ general.py           <span class="comment"># 项目通用函数代码</span></span><br><span class="line">│  ├─ google_app_engine</span><br><span class="line">│  │  ├─ additional_requirements.txt</span><br><span class="line">│  │  ├─ app.yaml</span><br><span class="line">│  │  └─ Dockerfile</span><br><span class="line">│  ├─ google_utils.py      <span class="comment"># 谷歌云使用相关代码</span></span><br><span class="line">│  ├─ loss.py              <span class="comment"># 损失函数代码</span></span><br><span class="line">│  ├─ metrics.py           <span class="comment"># 模型验证衡量指标</span></span><br><span class="line">│  ├─ plots.py             <span class="comment"># 画图代码</span></span><br><span class="line">│  ├─ torch_utils.py       <span class="comment"># 辅助程序代码</span></span><br><span class="line">│  └─ __init__.py</span><br><span class="line">└─ weights</span><br><span class="line">   ├─ download_weights.sh</span><br><span class="line">   ├─ yolov5m.pt           <span class="comment"># yolov5m 模型权重文件</span></span><br><span class="line">   └─ yolov5s.pt           <span class="comment"># yolov5s 模型权重文件</span></span><br></pre></td></tr></table></figure>
<h4 id="detect.py">detect.py</h4>
<p><code>detect.py</code> 用于前向推断，可支持多种流输入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># detect.py 源码解读</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="comment"># from numpy.core.fromnumeric import shape</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.backends.cudnn <span class="keyword">as</span> cudnn</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models.experimental <span class="keyword">import</span> attempt_load</span><br><span class="line"><span class="keyword">from</span> utils.datasets <span class="keyword">import</span> LoadStreams, LoadImages</span><br><span class="line"><span class="keyword">from</span> utils.general <span class="keyword">import</span> check_img_size, non_max_suppression, apply_classifier, scale_coords, xyxy2xywh, \</span><br><span class="line">    strip_optimizer, set_logging, increment_path</span><br><span class="line"><span class="keyword">from</span> utils.plots <span class="keyword">import</span> plot_one_box</span><br><span class="line"><span class="keyword">from</span> utils.torch_utils <span class="keyword">import</span> select_device, load_classifier, time_synchronized</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">整个网络检测流程：</span></span><br><span class="line"><span class="string">1. 创建保存输出文件的文件夹</span></span><br><span class="line"><span class="string">2. 加载模型文件，并做一些检查确保图片尺寸符合网络模型需求</span></span><br><span class="line"><span class="string">3. 根据输入源进行不同的数据加载方式</span></span><br><span class="line"><span class="string">4. 迭代数据集进行模型前向推断</span></span><br><span class="line"><span class="string">   - 非极大值抑制</span></span><br><span class="line"><span class="string">   - 为输出路径添加图片名称</span></span><br><span class="line"><span class="string">   - 调整预测框(resize + padding --&gt; 原图片坐标)</span></span><br><span class="line"><span class="string">   - 原图上画框和标签置信度、以及保存坐标框位置</span></span><br><span class="line"><span class="string">   - 保存图片、以及坐标框文件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detect</span>(<span class="params">save_img=<span class="literal">True</span></span>):</span></span><br><span class="line">    source, weights, view_img, save_txt, imgsz = opt.source, opt.weights, opt.view_img, opt.save_txt, opt.img_size</span><br><span class="line">    webcam = source.isnumeric() <span class="keyword">or</span> source.endswith(<span class="string">&#x27;.txt&#x27;</span>) <span class="keyword">or</span> source.lower().startswith(</span><br><span class="line">        (<span class="string">&#x27;rtsp://&#x27;</span>, <span class="string">&#x27;rtmp://&#x27;</span>, <span class="string">&#x27;http://&#x27;</span>)) <span class="comment"># 是否使用摄像头或网址视频等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Directories 设置图片保存路径</span></span><br><span class="line">    save_dir = Path(increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok))  <span class="comment"># increment run</span></span><br><span class="line">    <span class="comment"># make dir 创建文件夹</span></span><br><span class="line">    (save_dir / <span class="string">&#x27;labels&#x27;</span> <span class="keyword">if</span> save_txt <span class="keyword">else</span> save_dir).mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize</span></span><br><span class="line">    set_logging() <span class="comment"># 初始化日志文件</span></span><br><span class="line">    device = select_device(opt.device) <span class="comment"># 选择训练的设备 cpu, cuda</span></span><br><span class="line">    half = device.<span class="built_in">type</span> != <span class="string">&#x27;cpu&#x27;</span>  <span class="comment"># half precision only supported on CUDA 如设备为cpu, 则不能使用半精度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load model 加载模型</span></span><br><span class="line">    model = attempt_load(weights, map_location=device)  <span class="comment"># load FP32 model</span></span><br><span class="line">    imgsz = check_img_size(imgsz, s=model.stride.<span class="built_in">max</span>())  <span class="comment"># check img_size 确保图片能整除 32 （如果不能则调整为能整除并输出）</span></span><br><span class="line">    <span class="keyword">if</span> half:</span><br><span class="line">        model.half()  <span class="comment"># to FP16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Second-stage classifier 设置第二层分类器，默认不使用</span></span><br><span class="line">    classify = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> classify:</span><br><span class="line">        modelc = load_classifier(name=<span class="string">&#x27;resnet101&#x27;</span>, n=<span class="number">2</span>)  <span class="comment"># initialize 初始化模型</span></span><br><span class="line">        modelc.load_state_dict(torch.load(<span class="string">&#x27;weights/resnet101.pt&#x27;</span>, map_location=device)[<span class="string">&#x27;model&#x27;</span>]).to(device).<span class="built_in">eval</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 用来判断是否是另一个新视频</span></span><br><span class="line">    vid_path, vid_writer = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="comment"># Set Dataloader 根据不同的输入源来设置不同的数据加载方式</span></span><br><span class="line">    <span class="keyword">if</span> webcam:</span><br><span class="line">        view_img = <span class="literal">True</span></span><br><span class="line">        cudnn.benchmark = <span class="literal">True</span>  <span class="comment"># set True to speed up constant image size inference</span></span><br><span class="line">        dataset = LoadStreams(source, img_size=imgsz) <span class="comment"># 加载摄像头视频流</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        save_img = <span class="literal">True</span></span><br><span class="line">        dataset = LoadImages(source, img_size=imgsz) <span class="comment"># 加载图像或视频</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get names and colors</span></span><br><span class="line">    <span class="comment"># 获得数据集标签名称 以及为每一类设置一种颜色</span></span><br><span class="line">    names = model.module.names <span class="keyword">if</span> <span class="built_in">hasattr</span>(model, <span class="string">&#x27;module&#x27;</span>) <span class="keyword">else</span> model.names</span><br><span class="line">    colors = [[random.randint(<span class="number">0</span>, <span class="number">255</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> names]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run inference</span></span><br><span class="line">    img = torch.zeros((<span class="number">1</span>, <span class="number">3</span>, imgsz, imgsz), device=device)  <span class="comment"># init img</span></span><br><span class="line">    _ = model(img.half() <span class="keyword">if</span> half <span class="keyword">else</span> img) <span class="keyword">if</span> device.<span class="built_in">type</span> != <span class="string">&#x27;cpu&#x27;</span> <span class="keyword">else</span> <span class="literal">None</span>  <span class="comment"># run once 试运行一次，判断模型是否正常</span></span><br><span class="line">    <span class="comment"># 开始迭代</span></span><br><span class="line">    t0 = time.time()</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    path：图片路径</span></span><br><span class="line"><span class="string">    img：进行 resize 和 pad 之后的图片 (c, h, w) </span></span><br><span class="line"><span class="string">    img0s：原图片</span></span><br><span class="line"><span class="string">    vid_cap：判断是否是视频流</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> path, img, im0s, vid_cap <span class="keyword">in</span> dataset:</span><br><span class="line">        img = torch.from_numpy(img).to(device)</span><br><span class="line">        img = img.half() <span class="keyword">if</span> half <span class="keyword">else</span> img.<span class="built_in">float</span>()  <span class="comment"># uint8 to fp16/32</span></span><br><span class="line">        img /= <span class="number">255.0</span>  <span class="comment"># 0 - 255 to 0.0 - 1.0</span></span><br><span class="line">        <span class="keyword">if</span> img.ndimension() == <span class="number">3</span>: <span class="comment"># 如果没有 batch_size or batch_size=1，在最前面添加一个轴</span></span><br><span class="line">            img = img.unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Inference</span></span><br><span class="line"><span class="string">        框数量：(h/32 * w/32 + h/16 * w/16 + h/8 * w/8) * 3</span></span><br><span class="line"><span class="string">        pred 为模型输出结果（预测框）</span></span><br><span class="line"><span class="string">        pred[:,0:4]为预测框坐标</span></span><br><span class="line"><span class="string">        pred[:,4] 为 objectiveness 置信度</span></span><br><span class="line"><span class="string">        pred[:,5:-1] 为分类概率结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        t1 = time_synchronized()</span><br><span class="line">        pred = model(img, augment=opt.augment)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Apply NMS</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        pred</span></span><br><span class="line"><span class="string">        conf_thres</span></span><br><span class="line"><span class="string">        iou_thres</span></span><br><span class="line"><span class="string">        classes 是否保留特定类别</span></span><br><span class="line"><span class="string">        agnostic_nms 进行 nms 是否去除不同类别的框</span></span><br><span class="line"><span class="string">        max_det 最大的预测框数量</span></span><br><span class="line"><span class="string">        经过 nms 后 xywh -&gt; xyxy</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        pred = non_max_suppression(pred, opt.conf_thres, opt.iou_thres, classes=opt.classes, agnostic=opt.agnostic_nms)</span><br><span class="line">        t2 = time_synchronized() <span class="comment"># 使用时间同步记录当前时间(可能多个 GPU)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Apply Classifier 做二级分类</span></span><br><span class="line">        <span class="keyword">if</span> classify:</span><br><span class="line">            pred = apply_classifier(pred, modelc, img, im0s)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process detections</span></span><br><span class="line">        <span class="keyword">for</span> i, det <span class="keyword">in</span> <span class="built_in">enumerate</span>(pred):  <span class="comment"># detections per image (实际上每次只有一张图片)</span></span><br><span class="line">            <span class="keyword">if</span> webcam:  <span class="comment"># batch_size &gt;= 1</span></span><br><span class="line">                p, s, im0, frame = path[i], <span class="string">&#x27;%g: &#x27;</span> % i, im0s[i].copy(), dataset.count</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p, s, im0, frame = path, <span class="string">&#x27;&#x27;</span>, im0s, <span class="built_in">getattr</span>(dataset, <span class="string">&#x27;frame&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># p 是原图片路径</span></span><br><span class="line">            p = Path(p)  <span class="comment"># to Path</span></span><br><span class="line">            <span class="comment"># 设置保存图片或视频的路径</span></span><br><span class="line">            save_path = <span class="built_in">str</span>(save_dir / p.name)  <span class="comment"># img.jpg</span></span><br><span class="line">            <span class="comment"># 设置保存预测框坐标 .txt的路径</span></span><br><span class="line">            txt_path = <span class="built_in">str</span>(save_dir / <span class="string">&#x27;labels&#x27;</span> / p.stem) + (<span class="string">&#x27;&#x27;</span> <span class="keyword">if</span> dataset.mode == <span class="string">&#x27;image&#x27;</span> <span class="keyword">else</span> <span class="string">f&#x27;_<span class="subst">&#123;frame&#125;</span>&#x27;</span>)  <span class="comment"># img.txt</span></span><br><span class="line">            <span class="comment"># 设置打印信息</span></span><br><span class="line">            s += <span class="string">&#x27;%gx%g &#x27;</span> % img.shape[<span class="number">2</span>:]  <span class="comment"># print string</span></span><br><span class="line">            gn = torch.tensor(im0.shape)[[<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]]  <span class="comment"># normalization gain whwh 用于四个坐标 xyxy 的归一化</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(det):</span><br><span class="line">                <span class="comment"># Rescale boxes from img_size to im0 size</span></span><br><span class="line">                <span class="comment"># 调整预测框的坐标：基于 resize + pad 图片的坐标 --&gt; 基于原 size 图片的坐标</span></span><br><span class="line">                det[:, :<span class="number">4</span>] = scale_coords(img.shape[<span class="number">2</span>:], det[:, :<span class="number">4</span>], im0.shape).<span class="built_in">round</span>()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Print results 统计并记录检测到的每类的数量</span></span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> det[:, -<span class="number">1</span>].unique():</span><br><span class="line">                    n = (det[:, -<span class="number">1</span>] == c).<span class="built_in">sum</span>()  <span class="comment"># detections per class</span></span><br><span class="line">                    s += <span class="string">f&#x27;<span class="subst">&#123;n&#125;</span> <span class="subst">&#123;names[<span class="built_in">int</span>(c)]&#125;</span>s, &#x27;</span>  <span class="comment"># add to string</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Write results</span></span><br><span class="line">                <span class="comment"># 保存预测结果，依次保存每一个输出框，以及画出每一个输出框。</span></span><br><span class="line">                <span class="keyword">for</span> *xyxy, conf, cls <span class="keyword">in</span> <span class="built_in">reversed</span>(det):</span><br><span class="line">                    <span class="keyword">if</span> save_txt:  <span class="comment"># Write to file</span></span><br><span class="line">                        <span class="comment"># 先 xyxy --&gt; xywh，再归一化、转化为 list 再保存</span></span><br><span class="line">                        xywh = (xyxy2xywh(torch.tensor(xyxy).view(<span class="number">1</span>, <span class="number">4</span>)) / gn).view(-<span class="number">1</span>).tolist()  <span class="comment"># normalized xywh</span></span><br><span class="line">                        line = (cls, *xywh, conf) <span class="keyword">if</span> opt.save_conf <span class="keyword">else</span> (cls, *xywh)  <span class="comment"># label format</span></span><br><span class="line">                        <span class="keyword">with</span> <span class="built_in">open</span>(txt_path + <span class="string">&#x27;.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                            f.write((<span class="string">&#x27;%g &#x27;</span> * <span class="built_in">len</span>(line)).rstrip() % line + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                    <span class="comment"># 在原图上画框</span></span><br><span class="line">                    <span class="keyword">if</span> save_img <span class="keyword">or</span> view_img:  <span class="comment"># Add bbox to image</span></span><br><span class="line">                        label = <span class="string">f&#x27;<span class="subst">&#123;names[<span class="built_in">int</span>(cls)]&#125;</span> <span class="subst">&#123;conf:<span class="number">.2</span>f&#125;</span>&#x27;</span></span><br><span class="line">                        <span class="comment"># 直接在原图画框</span></span><br><span class="line">                        plot_one_box(xyxy, im0, label=label, color=colors[<span class="built_in">int</span>(cls)], line_thickness=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Print time (inference + NMS) # 输出一张图片推断时间</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;s&#125;</span>Done. (<span class="subst">&#123;t2 - t1:<span class="number">.3</span>f&#125;</span>s)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Stream results 设置展示</span></span><br><span class="line">            <span class="keyword">if</span> view_img:</span><br><span class="line">                cv2.imshow(<span class="built_in">str</span>(p), im0)</span><br><span class="line">                cv2.waitKey(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Save results (image with detections) 保存图片</span></span><br><span class="line">            <span class="keyword">if</span> save_img:</span><br><span class="line">                <span class="keyword">if</span> dataset.mode == <span class="string">&#x27;image&#x27;</span>:</span><br><span class="line">                    cv2.imwrite(save_path, im0)</span><br><span class="line">                <span class="keyword">else</span>:  <span class="comment"># &#x27;video&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span> vid_path != save_path:  <span class="comment"># 判断是不是另一个新的视频</span></span><br><span class="line">                        vid_path = save_path</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(vid_writer, cv2.VideoWriter):</span><br><span class="line">                            vid_writer.release()  <span class="comment"># release previous video writer</span></span><br><span class="line">                        <span class="keyword">if</span> vid_cap: <span class="comment"># video</span></span><br><span class="line">                            fps = vid_cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">                            w = <span class="built_in">int</span>(vid_cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">                            h = <span class="built_in">int</span>(vid_cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">                        <span class="keyword">else</span>: <span class="comment"># stream</span></span><br><span class="line">                            fps, w, h = <span class="number">30</span>, im0.shape[<span class="number">1</span>], im0.shape[<span class="number">2</span>]</span><br><span class="line">                            save_path += <span class="string">&#x27;.mp4&#x27;</span></span><br><span class="line">                        fourcc = <span class="string">&#x27;mp4v&#x27;</span>  <span class="comment"># output video codec</span></span><br><span class="line">                        vid_writer = cv2.VideoWriter(save_path, cv2.VideoWriter_fourcc(*fourcc), fps, (w, h))</span><br><span class="line">                    vid_writer.write(im0)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> save_txt <span class="keyword">or</span> save_img:</span><br><span class="line">        s = <span class="string">f&quot;\n<span class="subst">&#123;<span class="built_in">len</span>(<span class="built_in">list</span>(save_dir.glob(<span class="string">&#x27;labels/*.txt&#x27;</span>)))&#125;</span> labels saved to <span class="subst">&#123;save_dir / <span class="string">&#x27;labels&#x27;</span>&#125;</span>&quot;</span> <span class="keyword">if</span> save_txt <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Results saved to <span class="subst">&#123;save_dir&#125;</span><span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 打印总时间</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Done. (<span class="subst">&#123;time.time() - t0:<span class="number">.3</span>f&#125;</span>s)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--weights&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;weights/yolov5s.pt&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;model.pt path(s)&#x27;</span>) <span class="comment"># 模型权重文件</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--source&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;data/coco128/images/train2017&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;source&#x27;</span>)  <span class="comment"># file/folder, 0 for webcam # 数据源路径，0 则是使用摄像头</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--img-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">640</span>, <span class="built_in">help</span>=<span class="string">&#x27;inference size (pixels)&#x27;</span>) <span class="comment"># 输入模型的图片尺寸格式</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--conf-thres&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.25</span>, <span class="built_in">help</span>=<span class="string">&#x27;object confidence threshold&#x27;</span>) <span class="comment"># 置信度阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--iou-thres&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.45</span>, <span class="built_in">help</span>=<span class="string">&#x27;IOU threshold for NMS&#x27;</span>) <span class="comment"># IoU 阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--device&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>) <span class="comment"># 使用设备 </span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--view-img&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;display results&#x27;</span>) <span class="comment"># 检测时是否展示图片</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-txt&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save results to *.txt&#x27;</span>) <span class="comment"># 保存预测框数据</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-conf&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save confidences in --save-txt labels&#x27;</span>) <span class="comment"># 保留置信度</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--classes&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;filter by class: --class 0, or --class 0 2 3&#x27;</span>) <span class="comment"># 只检测哪几类</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--agnostic-nms&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;class-agnostic NMS&#x27;</span>) <span class="comment"># 进行 nms 是否去除不同类别的框</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--augment&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;augmented inference&#x27;</span>) <span class="comment"># 前向推断使用图像增广</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--update&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;update all models&#x27;</span>) <span class="comment"># </span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--project&#x27;</span>, default=<span class="string">&#x27;runs/detect&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save results to project/name&#x27;</span>) <span class="comment"># 预测结果输出文件目录</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--name&#x27;</span>, default=<span class="string">&#x27;exp&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save results to project/name&#x27;</span>) <span class="comment"># 文件夹名称</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--exist-ok&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;existing project/name ok, do not increment&#x27;</span>) <span class="comment"># 直接在已经存在的文件夹添加，不新建文件夹</span></span><br><span class="line">    opt = parser.parse_args()</span><br><span class="line">    <span class="built_in">print</span>(opt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">if</span> opt.update:  <span class="comment"># update all models (to fix SourceChangeWarning)</span></span><br><span class="line">            <span class="keyword">for</span> opt.weights <span class="keyword">in</span> [<span class="string">&#x27;yolov5s.pt&#x27;</span>, <span class="string">&#x27;yolov5m.pt&#x27;</span>, <span class="string">&#x27;yolov5l.pt&#x27;</span>, <span class="string">&#x27;yolov5x.pt&#x27;</span>]:</span><br><span class="line">                detect()</span><br><span class="line">                strip_optimizer(opt.weights)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            detect()</span><br></pre></td></tr></table></figure>
<h4 id="test.py">test.py</h4>
<p><code>test.py</code> 用于验证模型训练的效果 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py 源码解读</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models.experimental <span class="keyword">import</span> attempt_load</span><br><span class="line"><span class="keyword">from</span> utils.datasets <span class="keyword">import</span> create_dataloader</span><br><span class="line"><span class="keyword">from</span> utils.general <span class="keyword">import</span> coco80_to_coco91_class, check_dataset, check_file, check_img_size, box_iou, \</span><br><span class="line">    non_max_suppression, scale_coords, xyxy2xywh, xywh2xyxy, set_logging, increment_path</span><br><span class="line"><span class="keyword">from</span> utils.loss <span class="keyword">import</span> compute_loss</span><br><span class="line"><span class="keyword">from</span> utils.metrics <span class="keyword">import</span> ap_per_class, ConfusionMatrix</span><br><span class="line"><span class="keyword">from</span> utils.plots <span class="keyword">import</span> plot_images, output_to_target, plot_study_txt</span><br><span class="line"><span class="keyword">from</span> utils.torch_utils <span class="keyword">import</span> select_device, time_synchronized</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">测试模型分数流程：</span></span><br><span class="line"><span class="string">1. 检查数据集路径是否正确</span></span><br><span class="line"><span class="string">2. 加载模型（训练阶段则不需要）</span></span><br><span class="line"><span class="string">2. 加载数据集（训练模式不用加载数据集）</span></span><br><span class="line"><span class="string">3. 批量测试图片：</span></span><br><span class="line"><span class="string">    - 前向推断</span></span><br><span class="line"><span class="string">    - 非极大值抑制</span></span><br><span class="line"><span class="string">    - 保存输出结果 txt</span></span><br><span class="line"><span class="string">    - 保留 iou 状态信息</span></span><br><span class="line"><span class="string">    - 画出前三个 batch 图片</span></span><br><span class="line"><span class="string">4. 计算 mAP 等信息，保存信息。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">data,</span></span></span><br><span class="line"><span class="params"><span class="function">         weights=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         batch_size=<span class="number">32</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         imgsz=<span class="number">640</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         conf_thres=<span class="number">0.001</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         iou_thres=<span class="number">0.6</span>,  <span class="comment"># for NMS</span></span></span></span><br><span class="line"><span class="params"><span class="function">         save_json=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         single_cls=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         augment=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         verbose=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         model=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         dataloader=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         save_dir=Path(<span class="params"><span class="string">&#x27;&#x27;</span></span>),  <span class="comment"># for saving images</span></span></span></span><br><span class="line"><span class="params"><span class="function">         save_txt=<span class="literal">False</span>,  <span class="comment"># for auto-labelling</span></span></span></span><br><span class="line"><span class="params"><span class="function">         save_hybrid=<span class="literal">False</span>,  <span class="comment"># for hybrid auto-labelling</span></span></span></span><br><span class="line"><span class="params"><span class="function">         save_conf=<span class="literal">False</span>,  <span class="comment"># save auto-label confidences</span></span></span></span><br><span class="line"><span class="params"><span class="function">         plots=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">         log_imgs=<span class="number">0</span></span>):</span>  <span class="comment"># number of logged images</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize/load model and set device</span></span><br><span class="line">    training = model <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 判断是否是在训练阶段使用</span></span><br><span class="line">    <span class="keyword">if</span> training:  <span class="comment"># called by train.py</span></span><br><span class="line">        device = <span class="built_in">next</span>(model.parameters()).device  <span class="comment"># get model device</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># called directly</span></span><br><span class="line">        set_logging()</span><br><span class="line">        device = select_device(opt.device, batch_size=batch_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Directories</span></span><br><span class="line">        save_dir = Path(increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok))  <span class="comment"># increment run</span></span><br><span class="line">        (save_dir / <span class="string">&#x27;labels&#x27;</span> <span class="keyword">if</span> save_txt <span class="keyword">else</span> save_dir).mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)  <span class="comment"># make dir</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load model</span></span><br><span class="line">        model = attempt_load(weights, map_location=device)  <span class="comment"># load FP32 model</span></span><br><span class="line">        imgsz = check_img_size(imgsz, s=model.stride.<span class="built_in">max</span>())  <span class="comment"># check img_size</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Multi-GPU disabled, incompatible with .half() https://github.com/ultralytics/yolov5/issues/99</span></span><br><span class="line">        <span class="comment"># if device.type != &#x27;cpu&#x27; and torch.cuda.device_count() &gt; 1:</span></span><br><span class="line">        <span class="comment">#     model = nn.DataParallel(model)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Half</span></span><br><span class="line">    half = device.<span class="built_in">type</span> != <span class="string">&#x27;cpu&#x27;</span>  <span class="comment"># half precision only supported on CUDA</span></span><br><span class="line">    <span class="keyword">if</span> half:</span><br><span class="line">        model.half()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Configure</span></span><br><span class="line">    model.<span class="built_in">eval</span>() <span class="comment"># 表明是测试模式。会固定 BN 和 Dropout，用训练好的值；不启用 BatchNormalization 和 Dropout</span></span><br><span class="line">    is_coco = data.endswith(<span class="string">&#x27;coco.yaml&#x27;</span>)  <span class="comment"># is COCO dataset</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data) <span class="keyword">as</span> f:</span><br><span class="line">        data = yaml.load(f, Loader=yaml.FullLoader)  <span class="comment"># model dict</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># coco128.yaml 规定了 numbers of classes, train/val path, names of classes</span></span><br><span class="line">    check_dataset(data)  <span class="comment"># check 检查路径是否正确</span></span><br><span class="line">    nc = <span class="number">1</span> <span class="keyword">if</span> single_cls <span class="keyword">else</span> <span class="built_in">int</span>(data[<span class="string">&#x27;nc&#x27;</span>])  <span class="comment"># number of classes</span></span><br><span class="line">    iouv = torch.linspace(<span class="number">0.5</span>, <span class="number">0.95</span>, <span class="number">10</span>).to(device)  <span class="comment"># iou vector for mAP@0.5:0.95</span></span><br><span class="line">    niou = iouv.numel()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logging</span></span><br><span class="line">    log_imgs, wandb = <span class="built_in">min</span>(log_imgs, <span class="number">100</span>), <span class="literal">None</span>  <span class="comment"># ceil</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> wandb  <span class="comment"># Weights &amp; Biases</span></span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        log_imgs = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Dataloader 训练模式无需加载数据集</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> training:</span><br><span class="line">        img = torch.zeros((<span class="number">1</span>, <span class="number">3</span>, imgsz, imgsz), device=device)  <span class="comment"># init img</span></span><br><span class="line">        <span class="comment"># 模型试运行一次，检查模型是否正确</span></span><br><span class="line">        _ = model(img.half() <span class="keyword">if</span> half <span class="keyword">else</span> img) <span class="keyword">if</span> device.<span class="built_in">type</span> != <span class="string">&#x27;cpu&#x27;</span> <span class="keyword">else</span> <span class="literal">None</span>  <span class="comment"># run once </span></span><br><span class="line">        path = data[<span class="string">&#x27;test&#x27;</span>] <span class="keyword">if</span> opt.task == <span class="string">&#x27;test&#x27;</span> <span class="keyword">else</span> data[<span class="string">&#x27;val&#x27;</span>]  <span class="comment"># path to val/test images</span></span><br><span class="line">        dataloader = create_dataloader(path, imgsz, batch_size, model.stride.<span class="built_in">max</span>(), opt, pad=<span class="number">0.5</span>, rect=<span class="literal">True</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    seen = <span class="number">0</span></span><br><span class="line">    confusion_matrix = ConfusionMatrix(nc=nc)</span><br><span class="line">    names = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(model.names <span class="keyword">if</span> <span class="built_in">hasattr</span>(model, <span class="string">&#x27;names&#x27;</span>) <span class="keyword">else</span> model.module.names)&#125;</span><br><span class="line">    coco91class = coco80_to_coco91_class()</span><br><span class="line">    s = (<span class="string">&#x27;%20s&#x27;</span> + <span class="string">&#x27;%12s&#x27;</span> * <span class="number">6</span>) % (<span class="string">&#x27;Class&#x27;</span>, <span class="string">&#x27;Images&#x27;</span>, <span class="string">&#x27;Targets&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;mAP@.5&#x27;</span>, <span class="string">&#x27;mAP@.5:.95&#x27;</span>)</span><br><span class="line">    p, r, f1, mp, mr, map50, <span class="built_in">map</span>, t0, t1 = <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span> <span class="comment"># 初始化输出结果变量</span></span><br><span class="line">    loss = torch.zeros(<span class="number">3</span>, device=device) <span class="comment"># 初始化测试损失变量</span></span><br><span class="line">    jdict, stats, ap, ap_class, wandb_images = [], [], [], [], [] <span class="comment"># 初始化 json 文件、结果统计信息、ap</span></span><br><span class="line">    <span class="keyword">for</span> batch_i, (img, targets, paths, shapes) <span class="keyword">in</span> <span class="built_in">enumerate</span>(tqdm(dataloader, desc=s)):</span><br><span class="line">        img = img.to(device, non_blocking=<span class="literal">True</span>)</span><br><span class="line">        img = img.half() <span class="keyword">if</span> half <span class="keyword">else</span> img.<span class="built_in">float</span>()  <span class="comment"># uint8 to fp16/32</span></span><br><span class="line">        img /= <span class="number">255.0</span>  <span class="comment"># 0 - 255 to 0.0 - 1.0</span></span><br><span class="line">        targets = targets.to(device)</span><br><span class="line">        nb, _, height, width = img.shape  <span class="comment"># batch size, channels, height, width</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="comment"># Run model</span></span><br><span class="line">            t = time_synchronized()</span><br><span class="line">            inf_out, train_out = model(img, augment=augment)  <span class="comment"># inference and training outputs</span></span><br><span class="line">            t0 += time_synchronized() - t</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Compute loss</span></span><br><span class="line">            <span class="keyword">if</span> training: <span class="comment"># 用于训练时计算损失，测试时用不到</span></span><br><span class="line">                loss += compute_loss([x.<span class="built_in">float</span>() <span class="keyword">for</span> x <span class="keyword">in</span> train_out], targets, model)[<span class="number">1</span>][:<span class="number">3</span>]  <span class="comment"># box, obj, cls</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Run NMS</span></span><br><span class="line">            targets[:, <span class="number">2</span>:] *= torch.Tensor([width, height, width, height]).to(device)  <span class="comment"># to pixels</span></span><br><span class="line">            lb = [targets[targets[:, <span class="number">0</span>] == i, <span class="number">1</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nb)] <span class="keyword">if</span> save_hybrid <span class="keyword">else</span> []  <span class="comment"># for autolabelling</span></span><br><span class="line">            t = time_synchronized()</span><br><span class="line">            output = non_max_suppression(inf_out, conf_thres=conf_thres, iou_thres=iou_thres, labels=lb)</span><br><span class="line">            t1 += time_synchronized() - t</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Statistics per image 为每一张图片做统计，写入预测信息到 txt 文件，生成 json 文件，统计信息</span></span><br><span class="line">        <span class="keyword">for</span> si, pred <span class="keyword">in</span> <span class="built_in">enumerate</span>(output):</span><br><span class="line">            <span class="comment"># 获取第 si 张图片的真实标签信息(ground truth)</span></span><br><span class="line">            labels = targets[targets[:, <span class="number">0</span>] == si, <span class="number">1</span>:] <span class="comment"># 取出图片标注信息</span></span><br><span class="line">            nl = <span class="built_in">len</span>(labels)</span><br><span class="line">            tcls = labels[:, <span class="number">0</span>].tolist() <span class="keyword">if</span> nl <span class="keyword">else</span> []  <span class="comment"># target class</span></span><br><span class="line">            path = Path(paths[si])</span><br><span class="line">            seen += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(pred) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> nl:</span><br><span class="line">                    stats.append((torch.zeros(<span class="number">0</span>, niou, dtype=torch.<span class="built_in">bool</span>), torch.Tensor(), torch.Tensor(), tcls))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Predictions</span></span><br><span class="line">            predn = pred.clone()</span><br><span class="line">            scale_coords(img[si].shape[<span class="number">1</span>:], predn[:, :<span class="number">4</span>], shapes[si][<span class="number">0</span>], shapes[si][<span class="number">1</span>])  <span class="comment"># native-space pred</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Append to text file</span></span><br><span class="line">            <span class="keyword">if</span> save_txt:</span><br><span class="line">                gn = torch.tensor(shapes[si][<span class="number">0</span>])[[<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]]  <span class="comment"># normalization gain whwh</span></span><br><span class="line">                <span class="keyword">for</span> *xyxy, conf, cls <span class="keyword">in</span> predn.tolist():</span><br><span class="line">                    xywh = (xyxy2xywh(torch.tensor(xyxy).view(<span class="number">1</span>, <span class="number">4</span>)) / gn).view(-<span class="number">1</span>).tolist()  <span class="comment"># normalized xywh</span></span><br><span class="line">                    line = (cls, *xywh, conf) <span class="keyword">if</span> save_conf <span class="keyword">else</span> (cls, *xywh)  <span class="comment"># label format</span></span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(save_dir / <span class="string">&#x27;labels&#x27;</span> / (path.stem + <span class="string">&#x27;.txt&#x27;</span>), <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        f.write((<span class="string">&#x27;%g &#x27;</span> * <span class="built_in">len</span>(line)).rstrip() % line + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># W&amp;B logging</span></span><br><span class="line">            <span class="keyword">if</span> plots <span class="keyword">and</span> <span class="built_in">len</span>(wandb_images) &lt; log_imgs:</span><br><span class="line">                box_data = [&#123;<span class="string">&quot;position&quot;</span>: &#123;<span class="string">&quot;minX&quot;</span>: xyxy[<span class="number">0</span>], <span class="string">&quot;minY&quot;</span>: xyxy[<span class="number">1</span>], <span class="string">&quot;maxX&quot;</span>: xyxy[<span class="number">2</span>], <span class="string">&quot;maxY&quot;</span>: xyxy[<span class="number">3</span>]&#125;,</span><br><span class="line">                             <span class="string">&quot;class_id&quot;</span>: <span class="built_in">int</span>(cls),</span><br><span class="line">                             <span class="string">&quot;box_caption&quot;</span>: <span class="string">&quot;%s %.3f&quot;</span> % (names[cls], conf),</span><br><span class="line">                             <span class="string">&quot;scores&quot;</span>: &#123;<span class="string">&quot;class_score&quot;</span>: conf&#125;,</span><br><span class="line">                             <span class="string">&quot;domain&quot;</span>: <span class="string">&quot;pixel&quot;</span>&#125; <span class="keyword">for</span> *xyxy, conf, cls <span class="keyword">in</span> pred.tolist()]</span><br><span class="line">                boxes = &#123;<span class="string">&quot;predictions&quot;</span>: &#123;<span class="string">&quot;box_data&quot;</span>: box_data, <span class="string">&quot;class_labels&quot;</span>: names&#125;&#125;  <span class="comment"># inference-space</span></span><br><span class="line">                wandb_images.append(wandb.Image(img[si], boxes=boxes, caption=path.name))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Append to pycocotools JSON dictionary</span></span><br><span class="line">            <span class="comment"># coco json 格式：xywh(xy是左上角坐标)</span></span><br><span class="line">            <span class="keyword">if</span> save_json:</span><br><span class="line">                <span class="comment"># [&#123;&quot;image_id&quot;: 42, &quot;category_id&quot;: 18, &quot;bbox&quot;: [258.15, 41.29, 348.26, 243.78], &quot;score&quot;: 0.236&#125;, ...</span></span><br><span class="line">                image_id = <span class="built_in">int</span>(path.stem) <span class="keyword">if</span> path.stem.isnumeric() <span class="keyword">else</span> path.stem</span><br><span class="line">                box = xyxy2xywh(predn[:, :<span class="number">4</span>])  <span class="comment"># xywh</span></span><br><span class="line">                box[:, :<span class="number">2</span>] -= box[:, <span class="number">2</span>:] / <span class="number">2</span>  <span class="comment"># xy center to top-left corner</span></span><br><span class="line">                <span class="keyword">for</span> p, b <span class="keyword">in</span> <span class="built_in">zip</span>(pred.tolist(), box.tolist()):</span><br><span class="line">                    jdict.append(&#123;<span class="string">&#x27;image_id&#x27;</span>: image_id,</span><br><span class="line">                                  <span class="string">&#x27;category_id&#x27;</span>: coco91class[<span class="built_in">int</span>(p[<span class="number">5</span>])] <span class="keyword">if</span> is_coco <span class="keyword">else</span> <span class="built_in">int</span>(p[<span class="number">5</span>]),</span><br><span class="line">                                  <span class="string">&#x27;bbox&#x27;</span>: [<span class="built_in">round</span>(x, <span class="number">3</span>) <span class="keyword">for</span> x <span class="keyword">in</span> b],</span><br><span class="line">                                  <span class="string">&#x27;score&#x27;</span>: <span class="built_in">round</span>(p[<span class="number">4</span>], <span class="number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Assign all predictions as incorrect</span></span><br><span class="line">            <span class="comment"># 初始化预测评定，niou 为 iou 阈值的个数</span></span><br><span class="line">            correct = torch.zeros(pred.shape[<span class="number">0</span>], niou, dtype=torch.<span class="built_in">bool</span>, device=device)</span><br><span class="line">            <span class="keyword">if</span> nl:</span><br><span class="line">                detected = []  <span class="comment"># target indices</span></span><br><span class="line">                tcls_tensor = labels[:, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># target boxes</span></span><br><span class="line">                tbox = xywh2xyxy(labels[:, <span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line">                scale_coords(img[si].shape[<span class="number">1</span>:], tbox, shapes[si][<span class="number">0</span>], shapes[si][<span class="number">1</span>])  <span class="comment"># native-space labels</span></span><br><span class="line">                <span class="keyword">if</span> plots:</span><br><span class="line">                    confusion_matrix.process_batch(pred, torch.cat((labels[:, <span class="number">0</span>:<span class="number">1</span>], tbox), <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Per target class 对每个类单独处理</span></span><br><span class="line">                <span class="keyword">for</span> cls <span class="keyword">in</span> torch.unique(tcls_tensor):</span><br><span class="line">                    <span class="comment"># 标签框该类别的索引</span></span><br><span class="line">                    ti = (cls == tcls_tensor).nonzero(as_tuple=<span class="literal">False</span>).view(-<span class="number">1</span>)  <span class="comment"># prediction indices</span></span><br><span class="line">                    <span class="comment"># 预测框该类别的索引</span></span><br><span class="line">                    pi = (cls == pred[:, <span class="number">5</span>]).nonzero(as_tuple=<span class="literal">False</span>).view(-<span class="number">1</span>)  <span class="comment"># target indices</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Search for detections</span></span><br><span class="line">                    <span class="keyword">if</span> pi.shape[<span class="number">0</span>]:</span><br><span class="line">                        <span class="comment"># Prediction to target ious</span></span><br><span class="line">                        <span class="comment"># 计算预测框与标签框的 iou 值，并选出最大的 ious，i 为对应索引</span></span><br><span class="line">                        ious, i = box_iou(predn[pi, :<span class="number">4</span>], tbox[ti]).<span class="built_in">max</span>(<span class="number">1</span>)  <span class="comment"># best ious, indices</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment"># Append detections</span></span><br><span class="line">                        detected_set = <span class="built_in">set</span>()</span><br><span class="line">                        <span class="keyword">for</span> j <span class="keyword">in</span> (ious &gt; iouv[<span class="number">0</span>]).nonzero(as_tuple=<span class="literal">False</span>):</span><br><span class="line">                            d = ti[i[j]]  <span class="comment"># detected target</span></span><br><span class="line">                            <span class="keyword">if</span> d.item() <span class="keyword">not</span> <span class="keyword">in</span> detected_set:</span><br><span class="line">                                detected_set.add(d.item())</span><br><span class="line">                                detected.append(d)</span><br><span class="line">                                <span class="comment"># iouv 以 0.05 为步长，0.05 到 0.95 的列表</span></span><br><span class="line">                                <span class="comment"># 获得不同 iou 阈值下的 true positive</span></span><br><span class="line">                                correct[pi[j]] = ious[j] &gt; iouv  <span class="comment"># iou_thres is 1xn</span></span><br><span class="line">                                <span class="keyword">if</span> <span class="built_in">len</span>(detected) == nl:  <span class="comment"># all targets already located in image</span></span><br><span class="line">                                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Append statistics (correct, conf, pcls, tcls)</span></span><br><span class="line">            stats.append((correct.cpu(), pred[:, <span class="number">4</span>].cpu(), pred[:, <span class="number">5</span>].cpu(), tcls))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Plot images 分别画出前三个 batch 的真实标注框和预测框 </span></span><br><span class="line">        <span class="keyword">if</span> plots <span class="keyword">and</span> batch_i &lt; <span class="number">3</span>:</span><br><span class="line">            f = save_dir / <span class="string">f&#x27;test_batch<span class="subst">&#123;batch_i&#125;</span>_labels.jpg&#x27;</span>  <span class="comment"># labels</span></span><br><span class="line">            Thread(target=plot_images, args=(img, targets, paths, f, names), daemon=<span class="literal">True</span>).start()</span><br><span class="line">            f = save_dir / <span class="string">f&#x27;test_batch<span class="subst">&#123;batch_i&#125;</span>_pred.jpg&#x27;</span>  <span class="comment"># predictions</span></span><br><span class="line">            Thread(target=plot_images, args=(img, output_to_target(output), paths, f, names), daemon=<span class="literal">True</span>).start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute statistics</span></span><br><span class="line">    stats = [np.concatenate(x, <span class="number">0</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">zip</span>(*stats)]  <span class="comment"># to numpy</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(stats) <span class="keyword">and</span> stats[<span class="number">0</span>].<span class="built_in">any</span>():</span><br><span class="line">        <span class="comment"># precision = TP/(TP+FP), recall = TP/P, mAP, f1 分数, 各类别 ap</span></span><br><span class="line">        p, r, ap, f1, ap_class = ap_per_class(*stats, plot=plots, save_dir=save_dir, names=names)</span><br><span class="line">        p, r, ap50, ap = p[:, <span class="number">0</span>], r[:, <span class="number">0</span>], ap[:, <span class="number">0</span>], ap.mean(<span class="number">1</span>)  <span class="comment"># [P, R, AP@0.5, AP@0.5:0.95]</span></span><br><span class="line">        mp, mr, map50, <span class="built_in">map</span> = p.mean(), r.mean(), ap50.mean(), ap.mean()</span><br><span class="line">        <span class="comment"># nt 是一个列表，表示测试集中每个类别有多少个目标框</span></span><br><span class="line">        nt = np.bincount(stats[<span class="number">3</span>].astype(np.int64), minlength=nc)  <span class="comment"># number of targets per class</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        nt = torch.zeros(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print results</span></span><br><span class="line">    pf = <span class="string">&#x27;%20s&#x27;</span> + <span class="string">&#x27;%12.3g&#x27;</span> * <span class="number">6</span>  <span class="comment"># print format</span></span><br><span class="line">    <span class="built_in">print</span>(pf % (<span class="string">&#x27;all&#x27;</span>, seen, nt.<span class="built_in">sum</span>(), mp, mr, map50, <span class="built_in">map</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print results per class</span></span><br><span class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> nc &gt; <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(stats):</span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(ap_class):</span><br><span class="line">            <span class="built_in">print</span>(pf % (names[c], seen, nt[c], p[i], r[i], ap50[i], ap[i]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print speeds</span></span><br><span class="line">    t = <span class="built_in">tuple</span>(x / seen * <span class="number">1E3</span> <span class="keyword">for</span> x <span class="keyword">in</span> (t0, t1, t0 + t1)) + (imgsz, imgsz, batch_size)  <span class="comment"># tuple</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> training:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Speed: %.1f/%.1f/%.1f ms inference/NMS/total per %gx%g image at batch-size %g&#x27;</span> % t)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plots</span></span><br><span class="line">    <span class="keyword">if</span> plots:</span><br><span class="line">        confusion_matrix.plot(save_dir=save_dir, names=<span class="built_in">list</span>(names.values()))</span><br><span class="line">        <span class="keyword">if</span> wandb <span class="keyword">and</span> wandb.run:</span><br><span class="line">            wandb.log(&#123;<span class="string">&quot;Images&quot;</span>: wandb_images&#125;)</span><br><span class="line">            wandb.log(&#123;<span class="string">&quot;Validation&quot;</span>: [wandb.Image(<span class="built_in">str</span>(f), caption=f.name) <span class="keyword">for</span> f <span class="keyword">in</span> <span class="built_in">sorted</span>(save_dir.glob(<span class="string">&#x27;test*.jpg&#x27;</span>))]&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save JSON</span></span><br><span class="line">    <span class="comment"># 采用之前保存的 json 格式预测实验结果，通过 cocoapi 评估指标</span></span><br><span class="line">    <span class="comment"># 测试集标签也要传换成 coco 的 json 格式</span></span><br><span class="line">    <span class="keyword">if</span> save_json <span class="keyword">and</span> <span class="built_in">len</span>(jdict):</span><br><span class="line">        w = Path(weights[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">isinstance</span>(weights, <span class="built_in">list</span>) <span class="keyword">else</span> weights).stem <span class="keyword">if</span> weights <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  <span class="comment"># weights</span></span><br><span class="line">        anno_json = <span class="string">&#x27;../coco/annotations/instances_val2017.json&#x27;</span>  <span class="comment"># annotations json</span></span><br><span class="line">        pred_json = <span class="built_in">str</span>(save_dir / <span class="string">f&quot;<span class="subst">&#123;w&#125;</span>_predictions.json&quot;</span>)  <span class="comment"># predictions json</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nEvaluating pycocotools mAP... saving %s...&#x27;</span> % pred_json)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(pred_json, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(jdict, f)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:  <span class="comment"># https://github.com/cocodataset/cocoapi/blob/master/PythonAPI/pycocoEvalDemo.ipynb</span></span><br><span class="line">            <span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line">            <span class="keyword">from</span> pycocotools.cocoeval <span class="keyword">import</span> COCOeval</span><br><span class="line"></span><br><span class="line">            anno = COCO(anno_json)  <span class="comment"># init annotations api</span></span><br><span class="line">            pred = anno.loadRes(pred_json)  <span class="comment"># init predictions api</span></span><br><span class="line">            <span class="built_in">eval</span> = COCOeval(anno, pred, <span class="string">&#x27;bbox&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> is_coco:</span><br><span class="line">                <span class="built_in">eval</span>.params.imgIds = [<span class="built_in">int</span>(Path(x).stem) <span class="keyword">for</span> x <span class="keyword">in</span> dataloader.dataset.img_files]  <span class="comment"># image IDs to evaluate</span></span><br><span class="line">            <span class="built_in">eval</span>.evaluate()</span><br><span class="line">            <span class="built_in">eval</span>.accumulate()</span><br><span class="line">            <span class="built_in">eval</span>.summarize()</span><br><span class="line">            <span class="built_in">map</span>, map50 = <span class="built_in">eval</span>.stats[:<span class="number">2</span>]  <span class="comment"># update results (mAP@0.5:0.95, mAP@0.5)</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;pycocotools unable to run: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return results</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> training:</span><br><span class="line">        s = <span class="string">f&quot;\n<span class="subst">&#123;<span class="built_in">len</span>(<span class="built_in">list</span>(save_dir.glob(<span class="string">&#x27;labels/*.txt&#x27;</span>)))&#125;</span> labels saved to <span class="subst">&#123;save_dir / <span class="string">&#x27;labels&#x27;</span>&#125;</span>&quot;</span> <span class="keyword">if</span> save_txt <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Results saved to <span class="subst">&#123;save_dir&#125;</span><span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">    model.<span class="built_in">float</span>()  <span class="comment"># for training</span></span><br><span class="line">    maps = np.zeros(nc) + <span class="built_in">map</span></span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(ap_class):</span><br><span class="line">        maps[c] = ap[i]</span><br><span class="line">    <span class="keyword">return</span> (mp, mr, map50, <span class="built_in">map</span>, *(loss.cpu() / <span class="built_in">len</span>(dataloader)).tolist()), maps, t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(prog=<span class="string">&#x27;test.py&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--weights&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;weights/yolov5s.pt&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;model.pt path(s)&#x27;</span>) <span class="comment"># 权重文件路径</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--data&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;data/coco128.yaml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;*.data path&#x27;</span>) <span class="comment"># 测试的数据集或者配置文件</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--batch-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">16</span>, <span class="built_in">help</span>=<span class="string">&#x27;size of each image batch&#x27;</span>) <span class="comment"># batchsize</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--img-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">640</span>, <span class="built_in">help</span>=<span class="string">&#x27;inference size (pixels)&#x27;</span>) <span class="comment"># 输入模型的图片大小格式</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--conf-thres&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.001</span>, <span class="built_in">help</span>=<span class="string">&#x27;object confidence threshold&#x27;</span>) <span class="comment"># 置信度阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--iou-thres&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.6</span>, <span class="built_in">help</span>=<span class="string">&#x27;IOU threshold for NMS&#x27;</span>) <span class="comment"># IoU阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--task&#x27;</span>, default=<span class="string">&#x27;val&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;&#x27;val&#x27;, &#x27;test&#x27;, &#x27;study&#x27;&quot;</span>) <span class="comment"># 当前任务</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--device&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>) <span class="comment"># 设备</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--single-cls&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;treat as single-class dataset&#x27;</span>) <span class="comment"># 是否是做单类识别</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--augment&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;augmented inference&#x27;</span>) <span class="comment"># 数据增广</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--verbose&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;report mAP by class&#x27;</span>) <span class="comment"># 报告每类别的 mAP</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-txt&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save results to *.txt&#x27;</span>) <span class="comment"># 将预测框结果保留至 txt</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-hybrid&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save label+prediction hybrid results to *.txt&#x27;</span>) <span class="comment"># </span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-conf&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save confidences in --save-txt labels&#x27;</span>) <span class="comment"># 保留置信度阈值</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--save-json&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save a cocoapi-compatible JSON results file&#x27;</span>) <span class="comment">#</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--project&#x27;</span>, default=<span class="string">&#x27;runs/test&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save to project/name&#x27;</span>) <span class="comment"># 存放输出结果目录</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--name&#x27;</span>, default=<span class="string">&#x27;exp&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save to project/name&#x27;</span>) <span class="comment"># 输出结果存放文件夹</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--exist-ok&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;existing project/name ok, do not increment&#x27;</span>)</span><br><span class="line">    opt = parser.parse_args()</span><br><span class="line">    opt.save_json |= opt.data.endswith(<span class="string">&#x27;coco.yaml&#x27;</span>)</span><br><span class="line">    opt.data = check_file(opt.data)  <span class="comment"># check file 检查文件是否存在</span></span><br><span class="line">    <span class="built_in">print</span>(opt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opt.task <span class="keyword">in</span> [<span class="string">&#x27;val&#x27;</span>, <span class="string">&#x27;test&#x27;</span>]:  <span class="comment"># run normally</span></span><br><span class="line">        test(opt.data,</span><br><span class="line">             opt.weights,</span><br><span class="line">             opt.batch_size,</span><br><span class="line">             opt.img_size,</span><br><span class="line">             opt.conf_thres,</span><br><span class="line">             opt.iou_thres,</span><br><span class="line">             opt.save_json,</span><br><span class="line">             opt.single_cls,</span><br><span class="line">             opt.augment,</span><br><span class="line">             opt.verbose,</span><br><span class="line">             save_txt=opt.save_txt | opt.save_hybrid,</span><br><span class="line">             save_hybrid=opt.save_hybrid,</span><br><span class="line">             save_conf=opt.save_conf,</span><br><span class="line">             )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> opt.task == <span class="string">&#x27;study&#x27;</span>:  <span class="comment"># run over a range of settings and save/plot</span></span><br><span class="line">        <span class="keyword">for</span> weights <span class="keyword">in</span> [<span class="string">&#x27;yolov5s.pt&#x27;</span>, <span class="string">&#x27;yolov5m.pt&#x27;</span>, <span class="string">&#x27;yolov5l.pt&#x27;</span>, <span class="string">&#x27;yolov5x.pt&#x27;</span>]:</span><br><span class="line">            f = <span class="string">&#x27;study_%s_%s.txt&#x27;</span> % (Path(opt.data).stem, Path(weights).stem)  <span class="comment"># filename to save to</span></span><br><span class="line">            x = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">320</span>, <span class="number">800</span>, <span class="number">64</span>))  <span class="comment"># x axis</span></span><br><span class="line">            y = []  <span class="comment"># y axis</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> x:  <span class="comment"># img-size</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;\nRunning %s point %s...&#x27;</span> % (f, i))</span><br><span class="line">                r, _, t = test(opt.data, weights, opt.batch_size, i, opt.conf_thres, opt.iou_thres, opt.save_json,</span><br><span class="line">                               plots=<span class="literal">False</span>)</span><br><span class="line">                y.append(r + t)  <span class="comment"># results and times</span></span><br><span class="line">            np.savetxt(f, y, fmt=<span class="string">&#x27;%10.4g&#x27;</span>)  <span class="comment"># save</span></span><br><span class="line">        os.system(<span class="string">&#x27;zip -r study.zip study_*.txt&#x27;</span>)</span><br><span class="line">        plot_study_txt(f, x)  <span class="comment"># plot</span></span><br></pre></td></tr></table></figure></p>
<h4 id="train.py">train.py</h4>
<p><code>train.py</code> 训练模型的主要代码 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># train.py 源码解读</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> warnings <span class="keyword">import</span> warn</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.distributed <span class="keyword">as</span> dist</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.optim.lr_scheduler <span class="keyword">as</span> lr_scheduler</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> torch.cuda <span class="keyword">import</span> amp</span><br><span class="line"><span class="keyword">from</span> torch.nn.parallel <span class="keyword">import</span> DistributedDataParallel <span class="keyword">as</span> DDP</span><br><span class="line"><span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> test  <span class="comment"># import test.py to get mAP after each epoch</span></span><br><span class="line"><span class="keyword">from</span> models.experimental <span class="keyword">import</span> attempt_load</span><br><span class="line"><span class="keyword">from</span> models.yolo <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> utils.autoanchor <span class="keyword">import</span> check_anchors</span><br><span class="line"><span class="keyword">from</span> utils.datasets <span class="keyword">import</span> create_dataloader</span><br><span class="line"><span class="keyword">from</span> utils.general <span class="keyword">import</span> labels_to_class_weights, increment_path, labels_to_image_weights, init_seeds, \</span><br><span class="line">    fitness, strip_optimizer, get_latest_run, check_dataset, check_file, check_git_status, check_img_size, \</span><br><span class="line">    print_mutation, set_logging, one_cycle</span><br><span class="line"><span class="keyword">from</span> utils.google_utils <span class="keyword">import</span> attempt_download</span><br><span class="line"><span class="keyword">from</span> utils.loss <span class="keyword">import</span> compute_loss</span><br><span class="line"><span class="keyword">from</span> utils.plots <span class="keyword">import</span> plot_images, plot_labels, plot_results, plot_evolution</span><br><span class="line"><span class="keyword">from</span> utils.torch_utils <span class="keyword">import</span> ModelEMA, select_device, intersect_dicts, torch_distributed_zero_first</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    wandb = <span class="literal">None</span></span><br><span class="line">    logger.info(<span class="string">&quot;Install Weights &amp; Biases for experiment logging via &#x27;pip install wandb&#x27; (recommended)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span>(<span class="params">hyp, opt, device, tb_writer=<span class="literal">None</span>, wandb=<span class="literal">None</span></span>):</span></span><br><span class="line">    logger.info(<span class="string">f&#x27;Hyperparameters <span class="subst">&#123;hyp&#125;</span>&#x27;</span>)</span><br><span class="line">    save_dir, epochs, batch_size, total_batch_size, weights, rank = \</span><br><span class="line">        Path(opt.save_dir), opt.epochs, opt.batch_size, opt.total_batch_size, opt.weights, opt.global_rank</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Directories</span></span><br><span class="line">    <span class="comment"># 设置权重保存路径</span></span><br><span class="line">    wdir = save_dir / <span class="string">&#x27;weights&#x27;</span></span><br><span class="line">    wdir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)  <span class="comment"># make dir 创建文件夹</span></span><br><span class="line">    last = wdir / <span class="string">&#x27;last.pt&#x27;</span></span><br><span class="line">    best = wdir / <span class="string">&#x27;best.pt&#x27;</span></span><br><span class="line">    <span class="comment"># 设置保存 result 的路径</span></span><br><span class="line">    results_file = save_dir / <span class="string">&#x27;results.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save run settings 保留训练后的配置信息(超参数、配置参数 opt)</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_dir / <span class="string">&#x27;hyp.yaml&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        yaml.dump(hyp, f, sort_keys=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_dir / <span class="string">&#x27;opt.yaml&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        yaml.dump(<span class="built_in">vars</span>(opt), f, sort_keys=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Configure</span></span><br><span class="line">    plots = <span class="keyword">not</span> opt.evolve  <span class="comment"># create plots</span></span><br><span class="line">    cuda = device.<span class="built_in">type</span> != <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line">    init_seeds(<span class="number">2</span> + rank) <span class="comment"># 随机种子</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(opt.data) <span class="keyword">as</span> f:</span><br><span class="line">        data_dict = yaml.load(f, Loader=yaml.FullLoader)  <span class="comment"># data dict 加载数据集配置文件</span></span><br><span class="line">    <span class="keyword">with</span> torch_distributed_zero_first(rank):</span><br><span class="line">        check_dataset(data_dict)  <span class="comment"># check</span></span><br><span class="line">    <span class="comment"># 训练集路径</span></span><br><span class="line">    train_path = data_dict[<span class="string">&#x27;train&#x27;</span>]</span><br><span class="line">    <span class="comment"># 测试集路径</span></span><br><span class="line">    test_path = data_dict[<span class="string">&#x27;val&#x27;</span>]</span><br><span class="line">    nc = <span class="number">1</span> <span class="keyword">if</span> opt.single_cls <span class="keyword">else</span> <span class="built_in">int</span>(data_dict[<span class="string">&#x27;nc&#x27;</span>])  <span class="comment"># number of classes</span></span><br><span class="line">    names = [<span class="string">&#x27;item&#x27;</span>] <span class="keyword">if</span> opt.single_cls <span class="keyword">and</span> <span class="built_in">len</span>(data_dict[<span class="string">&#x27;names&#x27;</span>]) != <span class="number">1</span> <span class="keyword">else</span> data_dict[<span class="string">&#x27;names&#x27;</span>]  <span class="comment"># class names</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(names) == nc, <span class="string">&#x27;%g names found for nc=%g dataset in %s&#x27;</span> % (<span class="built_in">len</span>(names), nc, opt.data)  <span class="comment"># check</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model</span></span><br><span class="line">    pretrained = weights.endswith(<span class="string">&#x27;.pt&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        <span class="keyword">with</span> torch_distributed_zero_first(rank):</span><br><span class="line">            attempt_download(weights)  <span class="comment"># download if not found locally</span></span><br><span class="line">        ckpt = torch.load(weights, map_location=device)  <span class="comment"># load checkpoint 加载预训练模型</span></span><br><span class="line">        <span class="keyword">if</span> hyp.get(<span class="string">&#x27;anchors&#x27;</span>):</span><br><span class="line">            ckpt[<span class="string">&#x27;model&#x27;</span>].yaml[<span class="string">&#x27;anchors&#x27;</span>] = <span class="built_in">round</span>(hyp[<span class="string">&#x27;anchors&#x27;</span>])  <span class="comment"># force autoanchor</span></span><br><span class="line">        model = Model(opt.cfg <span class="keyword">or</span> ckpt[<span class="string">&#x27;model&#x27;</span>].yaml, ch=<span class="number">3</span>, nc=nc).to(device)  <span class="comment"># create</span></span><br><span class="line">        exclude = [<span class="string">&#x27;anchor&#x27;</span>] <span class="keyword">if</span> opt.cfg <span class="keyword">or</span> hyp.get(<span class="string">&#x27;anchors&#x27;</span>) <span class="keyword">else</span> []  <span class="comment"># exclude keys</span></span><br><span class="line">        state_dict = ckpt[<span class="string">&#x27;model&#x27;</span>].<span class="built_in">float</span>().state_dict()  <span class="comment"># to FP32</span></span><br><span class="line">        state_dict = intersect_dicts(state_dict, model.state_dict(), exclude=exclude)  <span class="comment"># intersect (去除了一些层)</span></span><br><span class="line">        model.load_state_dict(state_dict, strict=<span class="literal">False</span>)  <span class="comment"># load 加载模型参数</span></span><br><span class="line">        logger.info(<span class="string">&#x27;Transferred %g/%g items from %s&#x27;</span> % (<span class="built_in">len</span>(state_dict), <span class="built_in">len</span>(model.state_dict()), weights))  <span class="comment"># report</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        model = Model(opt.cfg, ch=<span class="number">3</span>, nc=nc).to(device)  <span class="comment"># create</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Freeze</span></span><br><span class="line">    freeze = []  <span class="comment"># parameter names to freeze (full or partial)</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> model.named_parameters():</span><br><span class="line">        v.requires_grad = <span class="literal">True</span>  <span class="comment"># train all layers</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(x <span class="keyword">in</span> k <span class="keyword">for</span> x <span class="keyword">in</span> freeze):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;freezing %s&#x27;</span> % k)</span><br><span class="line">            v.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optimizer</span></span><br><span class="line">    nbs = <span class="number">64</span>  <span class="comment"># nominal batch size</span></span><br><span class="line">    accumulate = <span class="built_in">max</span>(<span class="built_in">round</span>(nbs / total_batch_size), <span class="number">1</span>)  <span class="comment"># accumulate loss before optimizing</span></span><br><span class="line">    hyp[<span class="string">&#x27;weight_decay&#x27;</span>] *= total_batch_size * accumulate / nbs  <span class="comment"># scale weight_decay 权重衰减</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Scaled weight_decay = <span class="subst">&#123;hyp[<span class="string">&#x27;weight_decay&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将需要优化的参数分成三组</span></span><br><span class="line">    pg0, pg1, pg2 = [], [], []  <span class="comment"># optimizer parameter groups</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(v, <span class="string">&#x27;bias&#x27;</span>) <span class="keyword">and</span> <span class="built_in">isinstance</span>(v.bias, nn.Parameter):</span><br><span class="line">            pg2.append(v.bias)  <span class="comment"># biases 偏置项</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, nn.BatchNorm2d):</span><br><span class="line">            pg0.append(v.weight)  <span class="comment"># no decay 不进行权重衰减</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(v, <span class="string">&#x27;weight&#x27;</span>) <span class="keyword">and</span> <span class="built_in">isinstance</span>(v.weight, nn.Parameter):</span><br><span class="line">            pg1.append(v.weight)  <span class="comment"># apply decay 进行权重衰减</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opt.adam:</span><br><span class="line">        optimizer = optim.Adam(pg0, lr=hyp[<span class="string">&#x27;lr0&#x27;</span>], betas=(hyp[<span class="string">&#x27;momentum&#x27;</span>], <span class="number">0.999</span>))  <span class="comment"># adjust beta1 to momentum</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        optimizer = optim.SGD(pg0, lr=hyp[<span class="string">&#x27;lr0&#x27;</span>], momentum=hyp[<span class="string">&#x27;momentum&#x27;</span>], nesterov=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    optimizer.add_param_group(&#123;<span class="string">&#x27;params&#x27;</span>: pg1, <span class="string">&#x27;weight_decay&#x27;</span>: hyp[<span class="string">&#x27;weight_decay&#x27;</span>]&#125;)  <span class="comment"># add pg1 with weight_decay</span></span><br><span class="line">    optimizer.add_param_group(&#123;<span class="string">&#x27;params&#x27;</span>: pg2&#125;)  <span class="comment"># add pg2 (biases)</span></span><br><span class="line">    logger.info(<span class="string">&#x27;Optimizer groups: %g .bias, %g conv.weight, %g other&#x27;</span> % (<span class="built_in">len</span>(pg2), <span class="built_in">len</span>(pg1), <span class="built_in">len</span>(pg0)))</span><br><span class="line">    <span class="keyword">del</span> pg0, pg1, pg2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Scheduler https://arxiv.org/pdf/1812.01187.pdf</span></span><br><span class="line">    <span class="comment"># https://pytorch.org/docs/stable/_modules/torch/optim/lr_scheduler.html#OneCycleLR</span></span><br><span class="line">    lf = one_cycle(<span class="number">1</span>, hyp[<span class="string">&#x27;lrf&#x27;</span>], epochs)  <span class="comment"># cosine 1-&gt;hyp[&#x27;lrf&#x27;] 学习率使用余弦退火</span></span><br><span class="line">    scheduler = lr_scheduler.LambdaLR(optimizer, lr_lambda=lf) <span class="comment"># 学习率调整类实例化</span></span><br><span class="line">    <span class="comment"># plot_lr_scheduler(optimizer, scheduler, epochs)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logging</span></span><br><span class="line">    <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>] <span class="keyword">and</span> wandb <span class="keyword">and</span> wandb.run <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        opt.hyp = hyp  <span class="comment"># add hyperparameters</span></span><br><span class="line">        wandb_run = wandb.init(config=opt, resume=<span class="string">&quot;allow&quot;</span>,</span><br><span class="line">                               project=<span class="string">&#x27;YOLOv5&#x27;</span> <span class="keyword">if</span> opt.project == <span class="string">&#x27;runs/train&#x27;</span> <span class="keyword">else</span> Path(opt.project).stem,</span><br><span class="line">                               name=save_dir.stem,</span><br><span class="line">                               <span class="built_in">id</span>=ckpt.get(<span class="string">&#x27;wandb_id&#x27;</span>) <span class="keyword">if</span> <span class="string">&#x27;ckpt&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line">    loggers = &#123;<span class="string">&#x27;wandb&#x27;</span>: wandb&#125;  <span class="comment"># loggers dict</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Resume</span></span><br><span class="line">    start_epoch, best_fitness = <span class="number">0</span>, <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        <span class="comment"># Optimizer</span></span><br><span class="line">        <span class="keyword">if</span> ckpt[<span class="string">&#x27;optimizer&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            optimizer.load_state_dict(ckpt[<span class="string">&#x27;optimizer&#x27;</span>])</span><br><span class="line">            best_fitness = ckpt[<span class="string">&#x27;best_fitness&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Results</span></span><br><span class="line">        <span class="keyword">if</span> ckpt.get(<span class="string">&#x27;training_results&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(results_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                file.write(ckpt[<span class="string">&#x27;training_results&#x27;</span>])  <span class="comment"># write results.txt</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Epochs</span></span><br><span class="line">        start_epoch = ckpt[<span class="string">&#x27;epoch&#x27;</span>] + <span class="number">1</span> <span class="comment"># 非 resume 为零；resume则接着上次训练的 epoch</span></span><br><span class="line">        <span class="keyword">if</span> opt.resume:</span><br><span class="line">            <span class="keyword">assert</span> start_epoch &gt; <span class="number">0</span>, <span class="string">&#x27;%s training to %g epochs is finished, nothing to resume.&#x27;</span> % (weights, epochs)</span><br><span class="line">        <span class="keyword">if</span> epochs &lt; start_epoch: <span class="comment"># 若epochs 小于 start_epoch，则认为还需要训练 epochs 个 epoch。</span></span><br><span class="line">            logger.info(<span class="string">&#x27;%s has been trained for %g epochs. Fine-tuning for %g additional epochs.&#x27;</span> %</span><br><span class="line">                        (weights, ckpt[<span class="string">&#x27;epoch&#x27;</span>], epochs))</span><br><span class="line">            epochs += ckpt[<span class="string">&#x27;epoch&#x27;</span>]  <span class="comment"># finetune additional epochs</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">del</span> ckpt, state_dict</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Image sizes</span></span><br><span class="line">    gs = <span class="built_in">int</span>(model.stride.<span class="built_in">max</span>())  <span class="comment"># grid size (max stride)</span></span><br><span class="line">    nl = model.model[-<span class="number">1</span>].nl  <span class="comment"># number of detection layers (used for scaling hyp[&#x27;obj&#x27;]) 检测层的个数(有几个特征层融合)</span></span><br><span class="line">    imgsz, imgsz_test = [check_img_size(x, gs) <span class="keyword">for</span> x <span class="keyword">in</span> opt.img_size]  <span class="comment"># verify imgsz are gs-multiples</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DP mode</span></span><br><span class="line">    <span class="keyword">if</span> cuda <span class="keyword">and</span> rank == -<span class="number">1</span> <span class="keyword">and</span> torch.cuda.device_count() &gt; <span class="number">1</span>:</span><br><span class="line">        model = torch.nn.DataParallel(model)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SyncBatchNorm</span></span><br><span class="line">    <span class="keyword">if</span> opt.sync_bn <span class="keyword">and</span> cuda <span class="keyword">and</span> rank != -<span class="number">1</span>:</span><br><span class="line">        model = torch.nn.SyncBatchNorm.convert_sync_batchnorm(model).to(device)</span><br><span class="line">        logger.info(<span class="string">&#x27;Using SyncBatchNorm()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># EMA</span></span><br><span class="line">    ema = ModelEMA(model) <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DDP mode</span></span><br><span class="line">    <span class="keyword">if</span> cuda <span class="keyword">and</span> rank != -<span class="number">1</span>:</span><br><span class="line">        model = DDP(model, device_ids=[opt.local_rank], output_device=opt.local_rank)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Trainloader 训练数据集</span></span><br><span class="line">    dataloader, dataset = create_dataloader(train_path, imgsz, batch_size, gs, opt,</span><br><span class="line">                                            hyp=hyp, augment=<span class="literal">True</span>, cache=opt.cache_images, rect=opt.rect, rank=rank,</span><br><span class="line">                                            world_size=opt.world_size, workers=opt.workers,</span><br><span class="line">                                            image_weights=opt.image_weights, quad=opt.quad)</span><br><span class="line">    mlc = np.concatenate(dataset.labels, <span class="number">0</span>)[:, <span class="number">0</span>].<span class="built_in">max</span>()  <span class="comment"># max label class 求最大的标签类别</span></span><br><span class="line">    nb = <span class="built_in">len</span>(dataloader)  <span class="comment"># number of batches</span></span><br><span class="line">    <span class="keyword">assert</span> mlc &lt; nc, <span class="string">&#x27;Label class %g exceeds nc=%g in %s. Possible class labels are 0-%g&#x27;</span> % (mlc, nc, opt.data, nc - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process 0</span></span><br><span class="line">    <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">        ema.updates = start_epoch * nb // accumulate  <span class="comment"># set EMA updates</span></span><br><span class="line">        <span class="comment"># 测试数据集</span></span><br><span class="line">        testloader = create_dataloader(test_path, imgsz_test, total_batch_size, gs, opt,  <span class="comment"># testloader</span></span><br><span class="line">                                       hyp=hyp, cache=opt.cache_images <span class="keyword">and</span> <span class="keyword">not</span> opt.notest, rect=<span class="literal">True</span>,</span><br><span class="line">                                       rank=-<span class="number">1</span>, world_size=opt.world_size, workers=opt.workers, pad=<span class="number">0.5</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> opt.resume:</span><br><span class="line">            labels = np.concatenate(dataset.labels, <span class="number">0</span>) <span class="comment"># 将所有的训练数据标签信息合并</span></span><br><span class="line">            c = torch.tensor(labels[:, <span class="number">0</span>])  <span class="comment"># classes 将类别信息提取出来</span></span><br><span class="line">            <span class="comment"># cf = torch.bincount(c.long(), minlength=nc) + 1.  # frequency</span></span><br><span class="line">            <span class="comment"># model._initialize_biases(cf.to(device))</span></span><br><span class="line">            <span class="keyword">if</span> plots:</span><br><span class="line">                plot_labels(labels, save_dir, loggers) <span class="comment"># 画出所有的标签框</span></span><br><span class="line">                <span class="keyword">if</span> tb_writer:</span><br><span class="line">                    tb_writer.add_histogram(<span class="string">&#x27;classes&#x27;</span>, c, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Anchors</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> opt.noautoanchor: <span class="comment"># 使用自动计算锚框</span></span><br><span class="line">                check_anchors(dataset, model=model, thr=hyp[<span class="string">&#x27;anchor_t&#x27;</span>], imgsz=imgsz)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model parameters</span></span><br><span class="line">    <span class="comment"># 根据自己数据集的类别数设置分类损失的系数</span></span><br><span class="line">    hyp[<span class="string">&#x27;cls&#x27;</span>] *= nc / <span class="number">80.</span>  <span class="comment"># scale hyp[&#x27;cls&#x27;] to class count</span></span><br><span class="line">    hyp[<span class="string">&#x27;obj&#x27;</span>] *= imgsz ** <span class="number">2</span> / <span class="number">640.</span> ** <span class="number">2</span> * <span class="number">3.</span> / nl  <span class="comment"># scale hyp[&#x27;obj&#x27;] to image size and output layers</span></span><br><span class="line">    model.nc = nc  <span class="comment"># attach number of classes to model</span></span><br><span class="line">    model.hyp = hyp  <span class="comment"># attach hyperparameters to model</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    tobj[b,a,gj,gi] = (1.0 - gr) + model.gr*iou.detach().clamp(0).type(tobj.dtype)</span></span><br><span class="line"><span class="string">    这里 gr = 1, 也就是完全使用标签框与预测框的 IoU 作为该预测框的 objectness 标签</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model.gr = <span class="number">1.0</span>  <span class="comment"># iou loss ratio (obj_loss = 1.0 or iou) # 使用标签框与预测框的 iou 作为该预测框的 objectness 标签</span></span><br><span class="line">    <span class="comment"># 使用训练样本标签获得权重(与类别中的目标数目成反比)</span></span><br><span class="line">    model.class_weights = labels_to_class_weights(dataset.labels, nc).to(device) * nc  <span class="comment"># attach class weights</span></span><br><span class="line">    <span class="comment"># 类别名称</span></span><br><span class="line">    model.names = names</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start training</span></span><br><span class="line">    t0 = time.time()</span><br><span class="line">    <span class="comment"># 获取热身训练的迭代次数</span></span><br><span class="line">    nw = <span class="built_in">max</span>(<span class="built_in">round</span>(hyp[<span class="string">&#x27;warmup_epochs&#x27;</span>] * nb), <span class="number">1000</span>)  <span class="comment"># number of warmup iterations, max(3 epochs, 1k iterations)</span></span><br><span class="line">    <span class="comment"># nw = min(nw, (epochs - start_epoch) / 2 * nb)  # limit warmup to &lt; 1/2 of training</span></span><br><span class="line">    maps = np.zeros(nc)  <span class="comment"># mAP per class</span></span><br><span class="line">    results = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span></span><br><span class="line">    <span class="comment"># 设置学习率衰减进行到的轮次，目的是打断训练之后，--resume 接着训练也能正常衔接之前的学习率衰减</span></span><br><span class="line">    scheduler.last_epoch = start_epoch - <span class="number">1</span>  <span class="comment"># do not move</span></span><br><span class="line">    <span class="comment"># 通过 torch 1.6 以上带的 api 进行混合精度训练</span></span><br><span class="line">    scaler = amp.GradScaler(enabled=cuda)</span><br><span class="line">    logger.info(<span class="string">&#x27;Image sizes %g train, %g test\n&#x27;</span></span><br><span class="line">                <span class="string">&#x27;Using %g dataloader workers\nLogging results to %s\n&#x27;</span></span><br><span class="line">                <span class="string">&#x27;Starting training for %g epochs...&#x27;</span> % (imgsz, imgsz_test, dataloader.num_workers, save_dir, epochs))</span><br><span class="line">    <span class="comment"># 开始训练</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(start_epoch, epochs):  <span class="comment"># epoch ------------------------------------------------------------------</span></span><br><span class="line">        model.train() <span class="comment"># 模型设置为训练模式</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Update image weights (optional)</span></span><br><span class="line">        <span class="keyword">if</span> opt.image_weights:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            如果设置进行图片采样策略</span></span><br><span class="line"><span class="string">            则根据前面初始化的图片采样权重 model.class_weights 以及 maps 配合每张图片包含的类别数</span></span><br><span class="line"><span class="string">            通过 random.choices 生成图片索引 indeces 从而进行采样</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># Generate indices</span></span><br><span class="line">            <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">                cw = model.class_weights.cpu().numpy() * (<span class="number">1</span> - maps) ** <span class="number">2</span> / nc  <span class="comment"># class weights</span></span><br><span class="line">                iw = labels_to_image_weights(dataset.labels, nc=nc, class_weights=cw)  <span class="comment"># image weights</span></span><br><span class="line">                dataset.indices = random.choices(<span class="built_in">range</span>(dataset.n), weights=iw, k=dataset.n)  <span class="comment"># rand weighted idx</span></span><br><span class="line">            <span class="comment"># Broadcast if DDP DDP模式则采用广播采样策略</span></span><br><span class="line">            <span class="keyword">if</span> rank != -<span class="number">1</span>:</span><br><span class="line">                indices = (torch.tensor(dataset.indices) <span class="keyword">if</span> rank == <span class="number">0</span> <span class="keyword">else</span> torch.zeros(dataset.n)).<span class="built_in">int</span>()</span><br><span class="line">                dist.broadcast(indices, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span> rank != <span class="number">0</span>:</span><br><span class="line">                    dataset.indices = indices.cpu().numpy()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Update mosaic border</span></span><br><span class="line">        <span class="comment"># b = int(random.uniform(0.25 * imgsz, 0.75 * imgsz + gs) // gs * gs)</span></span><br><span class="line">        <span class="comment"># dataset.mosaic_border = [b - imgsz, -b]  # height, width borders</span></span><br><span class="line">        <span class="comment"># 初始化训练时的平均损失信息</span></span><br><span class="line">        mloss = torch.zeros(<span class="number">4</span>, device=device)  <span class="comment"># mean losses</span></span><br><span class="line">        <span class="comment"># DDP 模式下打乱数据，ddp.sampler 基于 epoch + seed 作为随机种子</span></span><br><span class="line">        <span class="keyword">if</span> rank != -<span class="number">1</span>:</span><br><span class="line">            dataloader.sampler.set_epoch(epoch)</span><br><span class="line">        pbar = <span class="built_in">enumerate</span>(dataloader) <span class="comment"># 作为进度条使用</span></span><br><span class="line">        <span class="comment"># 日志信息</span></span><br><span class="line">        logger.info((<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;%10s&#x27;</span> * <span class="number">8</span>) % (<span class="string">&#x27;Epoch&#x27;</span>, <span class="string">&#x27;gpu_mem&#x27;</span>, <span class="string">&#x27;box&#x27;</span>, <span class="string">&#x27;obj&#x27;</span>, <span class="string">&#x27;cls&#x27;</span>, <span class="string">&#x27;total&#x27;</span>, <span class="string">&#x27;targets&#x27;</span>, <span class="string">&#x27;img_size&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">            pbar = tqdm(pbar, total=nb)  <span class="comment"># progress bar 创建进度条</span></span><br><span class="line">        optimizer.zero_grad() <span class="comment"># 梯度清零</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 开始每一个 batchsize 训练</span></span><br><span class="line">        <span class="keyword">for</span> i, (imgs, targets, paths, _) <span class="keyword">in</span> pbar:  <span class="comment"># batch -------------------------------------------------------------</span></span><br><span class="line">            ni = i + nb * epoch  <span class="comment"># number integrated batches (since train start)</span></span><br><span class="line">            imgs = imgs.to(device, non_blocking=<span class="literal">True</span>).<span class="built_in">float</span>() / <span class="number">255.0</span>  <span class="comment"># uint8 to float32, 0-255 to 0.0-1.0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Warmup</span></span><br><span class="line">            <span class="keyword">if</span> ni &lt;= nw:</span><br><span class="line">                xi = [<span class="number">0</span>, nw]  <span class="comment"># x interp</span></span><br><span class="line">                <span class="comment"># model.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span></span><br><span class="line">                accumulate = <span class="built_in">max</span>(<span class="number">1</span>, np.interp(ni, xi, [<span class="number">1</span>, nbs / total_batch_size]).<span class="built_in">round</span>())</span><br><span class="line">                <span class="keyword">for</span> j, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(optimizer.param_groups):</span><br><span class="line">                    <span class="comment"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span></span><br><span class="line">                    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    bias 学习率从 0.1 下降到 lr * lf(epoch)</span></span><br><span class="line"><span class="string">                    其他的参数学习率从 0 增加到 lr * lf(epoch)</span></span><br><span class="line"><span class="string">                    lf 为上面设置的余弦退火衰减函数</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    x[<span class="string">&#x27;lr&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="string">&#x27;warmup_bias_lr&#x27;</span>] <span class="keyword">if</span> j == <span class="number">2</span> <span class="keyword">else</span> <span class="number">0.0</span>, x[<span class="string">&#x27;initial_lr&#x27;</span>] * lf(epoch)])</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;momentum&#x27;</span> <span class="keyword">in</span> x:</span><br><span class="line">                        x[<span class="string">&#x27;momentum&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="string">&#x27;warmup_momentum&#x27;</span>], hyp[<span class="string">&#x27;momentum&#x27;</span>]])</span><br><span class="line">            <span class="comment"># 设置多尺度训练  从 imgsz * 0.5, imgsz * 1.5 + gs 中随机选取 </span></span><br><span class="line">            <span class="comment"># Multi-scale</span></span><br><span class="line">            <span class="keyword">if</span> opt.multi_scale:</span><br><span class="line">                sz = random.randrange(imgsz * <span class="number">0.5</span>, imgsz * <span class="number">1.5</span> + gs) // gs * gs  <span class="comment"># size</span></span><br><span class="line">                sf = sz / <span class="built_in">max</span>(imgs.shape[<span class="number">2</span>:])  <span class="comment"># scale factor</span></span><br><span class="line">                <span class="keyword">if</span> sf != <span class="number">1</span>:</span><br><span class="line">                    ns = [math.ceil(x * sf / gs) * gs <span class="keyword">for</span> x <span class="keyword">in</span> imgs.shape[<span class="number">2</span>:]]  <span class="comment"># new shape (stretched to gs-multiple)</span></span><br><span class="line">                    imgs = F.interpolate(imgs, size=ns, mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Forward</span></span><br><span class="line">            <span class="keyword">with</span> amp.autocast(enabled=cuda): <span class="comment"># 只有 forward 和 loss 计算使用混合精度</span></span><br><span class="line">                pred = model(imgs)  <span class="comment"># forward</span></span><br><span class="line">                loss, loss_items = compute_loss(pred, targets.to(device), model)  <span class="comment"># loss scaled by batch_size</span></span><br><span class="line">                <span class="keyword">if</span> rank != -<span class="number">1</span>:</span><br><span class="line">                    loss *= opt.world_size  <span class="comment"># gradient averaged between devices in DDP mode</span></span><br><span class="line">                <span class="keyword">if</span> opt.quad:</span><br><span class="line">                    loss *= <span class="number">4.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Backward</span></span><br><span class="line">            scaler.scale(loss).backward() <span class="comment"># 反向传播：Scales loss. 为了梯度放大</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Optimize</span></span><br><span class="line">            <span class="keyword">if</span> ni % accumulate == <span class="number">0</span>: <span class="comment"># 累计梯度后再更新。相当于扩大了 batchsize</span></span><br><span class="line">                <span class="comment"># scaler.step() 首先把梯度的值 unscale 回来</span></span><br><span class="line">                <span class="comment"># 如果梯度的值不是 infs 或 NaNs，那么调用 optimizer.step() 来更新权重</span></span><br><span class="line">                <span class="comment"># 否则，忽略 step 调用，从而保证权重不更新（不被破坏）</span></span><br><span class="line">                scaler.step(optimizer)  <span class="comment"># optimizer.step</span></span><br><span class="line">                scaler.update()</span><br><span class="line">                optimizer.zero_grad() <span class="comment"># 梯度清零</span></span><br><span class="line">                <span class="keyword">if</span> ema:</span><br><span class="line">                    ema.update(model)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Print</span></span><br><span class="line">            <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">                mloss = (mloss * i + loss_items) / (i + <span class="number">1</span>)  <span class="comment"># update mean losses</span></span><br><span class="line">                mem = <span class="string">&#x27;%.3gG&#x27;</span> % (torch.cuda.memory_reserved() / <span class="number">1E9</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="number">0</span>)  <span class="comment"># (GB)</span></span><br><span class="line">                s = (<span class="string">&#x27;%10s&#x27;</span> * <span class="number">2</span> + <span class="string">&#x27;%10.4g&#x27;</span> * <span class="number">6</span>) % (</span><br><span class="line">                    <span class="string">&#x27;%g/%g&#x27;</span> % (epoch, epochs - <span class="number">1</span>), mem, *mloss, targets.shape[<span class="number">0</span>], imgs.shape[-<span class="number">1</span>])</span><br><span class="line">                pbar.set_description(s)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Plot</span></span><br><span class="line">                <span class="comment"># 将前三次 batch 的带标签框图片输出保存</span></span><br><span class="line">                <span class="keyword">if</span> plots <span class="keyword">and</span> ni &lt; <span class="number">3</span>:</span><br><span class="line">                    f = save_dir / <span class="string">f&#x27;train_batch<span class="subst">&#123;ni&#125;</span>.jpg&#x27;</span>  <span class="comment"># filename</span></span><br><span class="line">                    Thread(target=plot_images, args=(imgs, targets, paths, f), daemon=<span class="literal">True</span>).start()</span><br><span class="line">                    <span class="comment"># if tb_writer:</span></span><br><span class="line">                    <span class="comment">#     tb_writer.add_image(f, result, dataformats=&#x27;HWC&#x27;, global_step=epoch)</span></span><br><span class="line">                    <span class="comment">#     tb_writer.add_graph(model, imgs)  # add model to tensorboard</span></span><br><span class="line">                <span class="keyword">elif</span> plots <span class="keyword">and</span> ni == <span class="number">3</span> <span class="keyword">and</span> wandb:</span><br><span class="line">                    wandb.log(&#123;<span class="string">&quot;Mosaics&quot;</span>: [wandb.Image(<span class="built_in">str</span>(x), caption=x.name) <span class="keyword">for</span> x <span class="keyword">in</span> save_dir.glob(<span class="string">&#x27;train*.jpg&#x27;</span>)]&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># end batch ------------------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># 进行学习率衰减</span></span><br><span class="line">        <span class="comment"># Scheduler </span></span><br><span class="line">        lr = [x[<span class="string">&#x27;lr&#x27;</span>] <span class="keyword">for</span> x <span class="keyword">in</span> optimizer.param_groups]  <span class="comment"># for tensorboard 保留上一次的学习率，用于日志输出</span></span><br><span class="line">        scheduler.step() <span class="comment"># 对学习率调整</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># DDP process 0 or single-GPU</span></span><br><span class="line">        <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">            <span class="comment"># mAP</span></span><br><span class="line">            <span class="comment"># 更新 EMA 属性</span></span><br><span class="line">            <span class="comment"># 添加 include 属性</span></span><br><span class="line">            <span class="keyword">if</span> ema:</span><br><span class="line">                ema.update_attr(model, include=[<span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;nc&#x27;</span>, <span class="string">&#x27;hyp&#x27;</span>, <span class="string">&#x27;gr&#x27;</span>, <span class="string">&#x27;names&#x27;</span>, <span class="string">&#x27;stride&#x27;</span>, <span class="string">&#x27;class_weights&#x27;</span>])</span><br><span class="line">            <span class="comment"># 判断是否是最后一轮</span></span><br><span class="line">            final_epoch = epoch + <span class="number">1</span> == epochs</span><br><span class="line">            <span class="comment"># 对测试集进行测试，计算 mAP 等指标</span></span><br><span class="line">            <span class="comment"># 测试时使用的是 EMA 模型</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> opt.notest <span class="keyword">or</span> final_epoch:  <span class="comment"># Calculate mAP</span></span><br><span class="line">                results, maps, times = test.test(opt.data,</span><br><span class="line">                                                 batch_size=total_batch_size,</span><br><span class="line">                                                 imgsz=imgsz_test,</span><br><span class="line">                                                 model=ema.ema,</span><br><span class="line">                                                 single_cls=opt.single_cls,</span><br><span class="line">                                                 dataloader=testloader,</span><br><span class="line">                                                 save_dir=save_dir,</span><br><span class="line">                                                 plots=plots <span class="keyword">and</span> final_epoch,</span><br><span class="line">                                                 log_imgs=opt.log_imgs <span class="keyword">if</span> wandb <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Write</span></span><br><span class="line">            <span class="comment"># 将指标写入 result.txt</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(results_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(s + <span class="string">&#x27;%10.4g&#x27;</span> * <span class="number">7</span> % results + <span class="string">&#x27;\n&#x27;</span>)  <span class="comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(opt.name) <span class="keyword">and</span> opt.bucket:</span><br><span class="line">                os.system(<span class="string">&#x27;gsutil cp %s gs://%s/results/results%s.txt&#x27;</span> % (results_file, opt.bucket, opt.name))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Log</span></span><br><span class="line">            tags = [<span class="string">&#x27;train/box_loss&#x27;</span>, <span class="string">&#x27;train/obj_loss&#x27;</span>, <span class="string">&#x27;train/cls_loss&#x27;</span>,  <span class="comment"># train loss</span></span><br><span class="line">                    <span class="string">&#x27;metrics/precision&#x27;</span>, <span class="string">&#x27;metrics/recall&#x27;</span>, <span class="string">&#x27;metrics/mAP_0.5&#x27;</span>, <span class="string">&#x27;metrics/mAP_0.5:0.95&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;val/box_loss&#x27;</span>, <span class="string">&#x27;val/obj_loss&#x27;</span>, <span class="string">&#x27;val/cls_loss&#x27;</span>,  <span class="comment"># val loss</span></span><br><span class="line">                    <span class="string">&#x27;x/lr0&#x27;</span>, <span class="string">&#x27;x/lr1&#x27;</span>, <span class="string">&#x27;x/lr2&#x27;</span>]  <span class="comment"># params</span></span><br><span class="line">            <span class="keyword">for</span> x, tag <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">list</span>(mloss[:-<span class="number">1</span>]) + <span class="built_in">list</span>(results) + lr, tags):</span><br><span class="line">                <span class="keyword">if</span> tb_writer:</span><br><span class="line">                    tb_writer.add_scalar(tag, x, epoch)  <span class="comment"># tensorboard</span></span><br><span class="line">                <span class="keyword">if</span> wandb:</span><br><span class="line">                    wandb.log(&#123;tag: x&#125;)  <span class="comment"># W&amp;B</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Update best mAP</span></span><br><span class="line">            fi = fitness(np.array(results).reshape(<span class="number">1</span>, -<span class="number">1</span>))  <span class="comment"># weighted combination of [P, R, mAP@.5, mAP@.5-.95]</span></span><br><span class="line">            <span class="keyword">if</span> fi &gt; best_fitness:</span><br><span class="line">                best_fitness = fi</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Save model</span></span><br><span class="line">            save = (<span class="keyword">not</span> opt.nosave) <span class="keyword">or</span> (final_epoch <span class="keyword">and</span> <span class="keyword">not</span> opt.evolve)</span><br><span class="line">            <span class="keyword">if</span> save:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(results_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># create checkpoint</span></span><br><span class="line">                    ckpt = &#123;<span class="string">&#x27;epoch&#x27;</span>: epoch,</span><br><span class="line">                            <span class="string">&#x27;best_fitness&#x27;</span>: best_fitness,</span><br><span class="line">                            <span class="string">&#x27;training_results&#x27;</span>: f.read(),</span><br><span class="line">                            <span class="string">&#x27;model&#x27;</span>: ema.ema,</span><br><span class="line">                            <span class="string">&#x27;optimizer&#x27;</span>: <span class="literal">None</span> <span class="keyword">if</span> final_epoch <span class="keyword">else</span> optimizer.state_dict(),</span><br><span class="line">                            <span class="string">&#x27;wandb_id&#x27;</span>: wandb_run.<span class="built_in">id</span> <span class="keyword">if</span> wandb <span class="keyword">else</span> <span class="literal">None</span>&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Save last, best and delete</span></span><br><span class="line">                torch.save(ckpt, last)</span><br><span class="line">                <span class="keyword">if</span> best_fitness == fi:</span><br><span class="line">                    torch.save(ckpt, best)</span><br><span class="line">                <span class="keyword">del</span> ckpt</span><br><span class="line">        <span class="comment"># end epoch ----------------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># end training</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">        <span class="comment"># Strip optimizers</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            strip_optimizer 函数将 optimizer 从 ckpt 去除</span></span><br><span class="line"><span class="string">            并且对模型进行 model.half() float32 --&gt; float16</span></span><br><span class="line"><span class="string">            可以减少模型大小，提高前向推理速度</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        final = best <span class="keyword">if</span> best.exists() <span class="keyword">else</span> last  <span class="comment"># final model</span></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> [last, best]:</span><br><span class="line">            <span class="keyword">if</span> f.exists():</span><br><span class="line">                strip_optimizer(f)  <span class="comment"># strip optimizers</span></span><br><span class="line">        <span class="keyword">if</span> opt.bucket:</span><br><span class="line">            os.system(<span class="string">f&#x27;gsutil cp <span class="subst">&#123;final&#125;</span> gs://<span class="subst">&#123;opt.bucket&#125;</span>/weights&#x27;</span>)  <span class="comment"># upload</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Plots</span></span><br><span class="line">        <span class="keyword">if</span> plots:</span><br><span class="line">            plot_results(save_dir=save_dir)  <span class="comment"># save as results.png</span></span><br><span class="line">            <span class="keyword">if</span> wandb:</span><br><span class="line">                files = [<span class="string">&#x27;results.png&#x27;</span>, <span class="string">&#x27;precision_recall_curve.png&#x27;</span>, <span class="string">&#x27;confusion_matrix.png&#x27;</span>]</span><br><span class="line">                wandb.log(&#123;<span class="string">&quot;Results&quot;</span>: [wandb.Image(<span class="built_in">str</span>(save_dir / f), caption=f) <span class="keyword">for</span> f <span class="keyword">in</span> files</span><br><span class="line">                                       <span class="keyword">if</span> (save_dir / f).exists()]&#125;)</span><br><span class="line">                <span class="keyword">if</span> opt.log_artifacts:</span><br><span class="line">                    wandb.log_artifact(artifact_or_path=<span class="built_in">str</span>(final), <span class="built_in">type</span>=<span class="string">&#x27;model&#x27;</span>, name=save_dir.stem)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Test best.pt</span></span><br><span class="line">        logger.info(<span class="string">&#x27;%g epochs completed in %.3f hours.\n&#x27;</span> % (epoch - start_epoch + <span class="number">1</span>, (time.time() - t0) / <span class="number">3600</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> opt.data.endswith(<span class="string">&#x27;coco.yaml&#x27;</span>) <span class="keyword">and</span> nc == <span class="number">80</span>:  <span class="comment"># if COCO</span></span><br><span class="line">            <span class="keyword">for</span> conf, iou, save_json <span class="keyword">in</span> ([<span class="number">0.25</span>, <span class="number">0.45</span>, <span class="literal">False</span>], [<span class="number">0.001</span>, <span class="number">0.65</span>, <span class="literal">True</span>]):  <span class="comment"># speed, mAP tests</span></span><br><span class="line">                results, _, _ = test.test(opt.data,</span><br><span class="line">                                          batch_size=total_batch_size,</span><br><span class="line">                                          imgsz=imgsz_test,</span><br><span class="line">                                          conf_thres=conf,</span><br><span class="line">                                          iou_thres=iou,</span><br><span class="line">                                          model=attempt_load(final, device).half(),</span><br><span class="line">                                          single_cls=opt.single_cls,</span><br><span class="line">                                          dataloader=testloader,</span><br><span class="line">                                          save_dir=save_dir,</span><br><span class="line">                                          save_json=save_json,</span><br><span class="line">                                          plots=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dist.destroy_process_group() <span class="comment"># 释放显存</span></span><br><span class="line"></span><br><span class="line">    wandb.run.finish() <span class="keyword">if</span> wandb <span class="keyword">and</span> wandb.run <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    torch.cuda.empty_cache()</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--weights&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;weights/yolov5s.pt&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;initial weights path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--cfg&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;models/yolov5s.yaml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;model.yaml path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--data&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;data/coco128.yaml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;data.yaml path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--hyp&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;data/hyp.scratch.yaml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;hyperparameters path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--epochs&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">2</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--batch-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">8</span>, <span class="built_in">help</span>=<span class="string">&#x27;total batch size for all GPUs&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--img-size&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">640</span>, <span class="number">640</span>], <span class="built_in">help</span>=<span class="string">&#x27;[train, test] image sizes&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--rect&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;rectangular training&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--resume&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>, const=<span class="literal">True</span>, default=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&#x27;resume most recent training&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--nosave&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;only save final checkpoint&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--notest&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;only test final epoch&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--noautoanchor&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;disable autoanchor check&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--evolve&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;evolve hyperparameters&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--bucket&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;gsutil bucket&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--cache-images&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;cache images for faster training&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--image-weights&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;use weighted image selection for training&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--device&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--multi-scale&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;vary img-size +/- 50%%&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--single-cls&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;train multi-class data as single-class&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--adam&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;use torch.optim.Adam() optimizer&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--sync-bn&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;use SyncBatchNorm, only available in DDP mode&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--local_rank&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=-<span class="number">1</span>, <span class="built_in">help</span>=<span class="string">&#x27;DDP parameter, do not modify&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--log-imgs&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">16</span>, <span class="built_in">help</span>=<span class="string">&#x27;number of images for W&amp;B logging, max 100&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--log-artifacts&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;log artifacts, i.e. final trained model&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--workers&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">8</span>, <span class="built_in">help</span>=<span class="string">&#x27;maximum number of dataloader workers&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--project&#x27;</span>, default=<span class="string">&#x27;runs/train&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save to project/name&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--name&#x27;</span>, default=<span class="string">&#x27;exp&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;save to project/name&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--exist-ok&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;existing project/name ok, do not increment&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--quad&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;quad dataloader&#x27;</span>)</span><br><span class="line">    opt = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set DDP variables 设置 DDP 模式的参数</span></span><br><span class="line">    opt.world_size = <span class="built_in">int</span>(os.environ[<span class="string">&#x27;WORLD_SIZE&#x27;</span>]) <span class="keyword">if</span> <span class="string">&#x27;WORLD_SIZE&#x27;</span> <span class="keyword">in</span> os.environ <span class="keyword">else</span> <span class="number">1</span> <span class="comment"># 全局进程个数</span></span><br><span class="line">    opt.global_rank = <span class="built_in">int</span>(os.environ[<span class="string">&#x27;RANK&#x27;</span>]) <span class="keyword">if</span> <span class="string">&#x27;RANK&#x27;</span> <span class="keyword">in</span> os.environ <span class="keyword">else</span> -<span class="number">1</span> <span class="comment"># 进程编号</span></span><br><span class="line">    set_logging(opt.global_rank)</span><br><span class="line">    <span class="keyword">if</span> opt.global_rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">        check_git_status()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Resume</span></span><br><span class="line">    <span class="keyword">if</span> opt.resume:  <span class="comment"># resume an interrupted run 是否是接着上次训练</span></span><br><span class="line">        ckpt = opt.resume <span class="keyword">if</span> <span class="built_in">isinstance</span>(opt.resume, <span class="built_in">str</span>) <span class="keyword">else</span> get_latest_run()  <span class="comment"># specified or most recent path</span></span><br><span class="line">        <span class="keyword">assert</span> os.path.isfile(ckpt), <span class="string">&#x27;ERROR: --resume checkpoint does not exist&#x27;</span></span><br><span class="line">        apriori = opt.global_rank, opt.local_rank</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(Path(ckpt).parent.parent / <span class="string">&#x27;opt.yaml&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            opt = argparse.Namespace(**yaml.load(f, Loader=yaml.FullLoader))  <span class="comment"># replace</span></span><br><span class="line">        opt.cfg, opt.weights, opt.resume, opt.global_rank, opt.local_rank = <span class="string">&#x27;&#x27;</span>, ckpt, <span class="literal">True</span>, *apriori  <span class="comment"># reinstate</span></span><br><span class="line">        logger.info(<span class="string">&#x27;Resuming training from %s&#x27;</span> % ckpt)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># opt.hyp = opt.hyp or (&#x27;hyp.finetune.yaml&#x27; if opt.weights else &#x27;hyp.scratch.yaml&#x27;)</span></span><br><span class="line">        <span class="comment"># 获取配置文件信息并检查</span></span><br><span class="line">        opt.data, opt.cfg, opt.hyp = check_file(opt.data), check_file(opt.cfg), check_file(opt.hyp)  <span class="comment"># check files</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(opt.cfg) <span class="keyword">or</span> <span class="built_in">len</span>(opt.weights), <span class="string">&#x27;either --cfg or --weights must be specified&#x27;</span></span><br><span class="line">        opt.img_size.extend([opt.img_size[-<span class="number">1</span>]] * (<span class="number">2</span> - <span class="built_in">len</span>(opt.img_size)))  <span class="comment"># extend to 2 sizes (train, test)</span></span><br><span class="line">        opt.name = <span class="string">&#x27;evolve&#x27;</span> <span class="keyword">if</span> opt.evolve <span class="keyword">else</span> opt.name</span><br><span class="line">        <span class="comment"># 生成保存文件输出目录</span></span><br><span class="line">        opt.save_dir = increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok | opt.evolve)  <span class="comment"># increment run</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DDP mode</span></span><br><span class="line">    opt.total_batch_size = opt.batch_size</span><br><span class="line">    device = select_device(opt.device, batch_size=opt.batch_size)</span><br><span class="line">    <span class="keyword">if</span> opt.local_rank != -<span class="number">1</span>: <span class="comment"># 多 GPU 情况</span></span><br><span class="line">        <span class="keyword">assert</span> torch.cuda.device_count() &gt; opt.local_rank</span><br><span class="line">        torch.cuda.set_device(opt.local_rank)</span><br><span class="line">        device = torch.device(<span class="string">&#x27;cuda&#x27;</span>, opt.local_rank)</span><br><span class="line">        dist.init_process_group(backend=<span class="string">&#x27;nccl&#x27;</span>, init_method=<span class="string">&#x27;env://&#x27;</span>)  <span class="comment"># distributed backend</span></span><br><span class="line">        <span class="keyword">assert</span> opt.batch_size % opt.world_size == <span class="number">0</span>, <span class="string">&#x27;--batch-size must be multiple of CUDA device count&#x27;</span></span><br><span class="line">        opt.batch_size = opt.total_batch_size // opt.world_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Hyperparameters</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(opt.hyp) <span class="keyword">as</span> f:</span><br><span class="line">        hyp = yaml.load(f, Loader=yaml.FullLoader)  <span class="comment"># load hyps 加载超参数配置文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;box&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> hyp:</span><br><span class="line">            warn(<span class="string">&#x27;Compatibility: %s missing &quot;box&quot; which was renamed from &quot;giou&quot; in %s&#x27;</span> %</span><br><span class="line">                 (opt.hyp, <span class="string">&#x27;https://github.com/ultralytics/yolov5/pull/1120&#x27;</span>))</span><br><span class="line">            hyp[<span class="string">&#x27;box&#x27;</span>] = hyp.pop(<span class="string">&#x27;giou&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Train</span></span><br><span class="line">    logger.info(opt) <span class="comment"># 打印 opt 参数信息</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> opt.evolve:</span><br><span class="line">        tb_writer = <span class="literal">None</span>  <span class="comment"># init loggers</span></span><br><span class="line">        <span class="keyword">if</span> opt.global_rank <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">            logger.info(<span class="string">f&#x27;Start Tensorboard with &quot;tensorboard --logdir <span class="subst">&#123;opt.project&#125;</span>&quot;, view at http://localhost:6006/&#x27;</span>)</span><br><span class="line">            tb_writer = SummaryWriter(opt.save_dir)  <span class="comment"># Tensorboard</span></span><br><span class="line">        train(hyp, opt, device, tb_writer, wandb)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Evolve hyperparameters (optional)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Hyperparameter evolution metadata (mutation scale 0-1, lower_limit, upper_limit)</span></span><br><span class="line">        meta = &#123;<span class="string">&#x27;lr0&#x27;</span>: (<span class="number">1</span>, <span class="number">1e-5</span>, <span class="number">1e-1</span>),  <span class="comment"># initial learning rate (SGD=1E-2, Adam=1E-3)</span></span><br><span class="line">                <span class="string">&#x27;lrf&#x27;</span>: (<span class="number">1</span>, <span class="number">0.01</span>, <span class="number">1.0</span>),  <span class="comment"># final OneCycleLR learning rate (lr0 * lrf)</span></span><br><span class="line">                <span class="string">&#x27;momentum&#x27;</span>: (<span class="number">0.3</span>, <span class="number">0.6</span>, <span class="number">0.98</span>),  <span class="comment"># SGD momentum/Adam beta1</span></span><br><span class="line">                <span class="string">&#x27;weight_decay&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.001</span>),  <span class="comment"># optimizer weight decay</span></span><br><span class="line">                <span class="string">&#x27;warmup_epochs&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">5.0</span>),  <span class="comment"># warmup epochs (fractions ok)</span></span><br><span class="line">                <span class="string">&#x27;warmup_momentum&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.95</span>),  <span class="comment"># warmup initial momentum</span></span><br><span class="line">                <span class="string">&#x27;warmup_bias_lr&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.2</span>),  <span class="comment"># warmup initial bias lr</span></span><br><span class="line">                <span class="string">&#x27;box&#x27;</span>: (<span class="number">1</span>, <span class="number">0.02</span>, <span class="number">0.2</span>),  <span class="comment"># box loss gain</span></span><br><span class="line">                <span class="string">&#x27;cls&#x27;</span>: (<span class="number">1</span>, <span class="number">0.2</span>, <span class="number">4.0</span>),  <span class="comment"># cls loss gain</span></span><br><span class="line">                <span class="string">&#x27;cls_pw&#x27;</span>: (<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">2.0</span>),  <span class="comment"># cls BCELoss positive_weight</span></span><br><span class="line">                <span class="string">&#x27;obj&#x27;</span>: (<span class="number">1</span>, <span class="number">0.2</span>, <span class="number">4.0</span>),  <span class="comment"># obj loss gain (scale with pixels)</span></span><br><span class="line">                <span class="string">&#x27;obj_pw&#x27;</span>: (<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">2.0</span>),  <span class="comment"># obj BCELoss positive_weight</span></span><br><span class="line">                <span class="string">&#x27;iou_t&#x27;</span>: (<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0.7</span>),  <span class="comment"># IoU training threshold</span></span><br><span class="line">                <span class="string">&#x27;anchor_t&#x27;</span>: (<span class="number">1</span>, <span class="number">2.0</span>, <span class="number">8.0</span>),  <span class="comment"># anchor-multiple threshold</span></span><br><span class="line">                <span class="string">&#x27;anchors&#x27;</span>: (<span class="number">2</span>, <span class="number">2.0</span>, <span class="number">10.0</span>),  <span class="comment"># anchors per output grid (0 to ignore)</span></span><br><span class="line">                <span class="string">&#x27;fl_gamma&#x27;</span>: (<span class="number">0</span>, <span class="number">0.0</span>, <span class="number">2.0</span>),  <span class="comment"># focal loss gamma (efficientDet default gamma=1.5)</span></span><br><span class="line">                <span class="string">&#x27;hsv_h&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.1</span>),  <span class="comment"># image HSV-Hue augmentation (fraction)</span></span><br><span class="line">                <span class="string">&#x27;hsv_s&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.9</span>),  <span class="comment"># image HSV-Saturation augmentation (fraction)</span></span><br><span class="line">                <span class="string">&#x27;hsv_v&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.9</span>),  <span class="comment"># image HSV-Value augmentation (fraction)</span></span><br><span class="line">                <span class="string">&#x27;degrees&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">45.0</span>),  <span class="comment"># image rotation (+/- deg)</span></span><br><span class="line">                <span class="string">&#x27;translate&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.9</span>),  <span class="comment"># image translation (+/- fraction)</span></span><br><span class="line">                <span class="string">&#x27;scale&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">0.9</span>),  <span class="comment"># image scale (+/- gain)</span></span><br><span class="line">                <span class="string">&#x27;shear&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">10.0</span>),  <span class="comment"># image shear (+/- deg)</span></span><br><span class="line">                <span class="string">&#x27;perspective&#x27;</span>: (<span class="number">0</span>, <span class="number">0.0</span>, <span class="number">0.001</span>),  <span class="comment"># image perspective (+/- fraction), range 0-0.001</span></span><br><span class="line">                <span class="string">&#x27;flipud&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">1.0</span>),  <span class="comment"># image flip up-down (probability)</span></span><br><span class="line">                <span class="string">&#x27;fliplr&#x27;</span>: (<span class="number">0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>),  <span class="comment"># image flip left-right (probability)</span></span><br><span class="line">                <span class="string">&#x27;mosaic&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">1.0</span>),  <span class="comment"># image mixup (probability)</span></span><br><span class="line">                <span class="string">&#x27;mixup&#x27;</span>: (<span class="number">1</span>, <span class="number">0.0</span>, <span class="number">1.0</span>)&#125;  <span class="comment"># image mixup (probability)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> opt.local_rank == -<span class="number">1</span>, <span class="string">&#x27;DDP mode not implemented for --evolve&#x27;</span></span><br><span class="line">        opt.notest, opt.nosave = <span class="literal">True</span>, <span class="literal">True</span>  <span class="comment"># only test/save final epoch</span></span><br><span class="line">        <span class="comment"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span></span><br><span class="line">        yaml_file = Path(opt.save_dir) / <span class="string">&#x27;hyp_evolved.yaml&#x27;</span>  <span class="comment"># save best result here</span></span><br><span class="line">        <span class="keyword">if</span> opt.bucket:</span><br><span class="line">            os.system(<span class="string">&#x27;gsutil cp gs://%s/evolve.txt .&#x27;</span> % opt.bucket)  <span class="comment"># download evolve.txt if exists</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>):  <span class="comment"># generations to evolve</span></span><br><span class="line">            <span class="keyword">if</span> Path(<span class="string">&#x27;evolve.txt&#x27;</span>).exists():  <span class="comment"># if evolve.txt exists: select best hyps and mutate</span></span><br><span class="line">                <span class="comment"># Select parent(s)</span></span><br><span class="line">                parent = <span class="string">&#x27;single&#x27;</span>  <span class="comment"># parent selection method: &#x27;single&#x27; or &#x27;weighted&#x27;</span></span><br><span class="line">                x = np.loadtxt(<span class="string">&#x27;evolve.txt&#x27;</span>, ndmin=<span class="number">2</span>)</span><br><span class="line">                n = <span class="built_in">min</span>(<span class="number">5</span>, <span class="built_in">len</span>(x))  <span class="comment"># number of previous results to consider</span></span><br><span class="line">                x = x[np.argsort(-fitness(x))][:n]  <span class="comment"># top n mutations</span></span><br><span class="line">                w = fitness(x) - fitness(x).<span class="built_in">min</span>()  <span class="comment"># weights</span></span><br><span class="line">                <span class="keyword">if</span> parent == <span class="string">&#x27;single&#x27;</span> <span class="keyword">or</span> <span class="built_in">len</span>(x) == <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># x = x[random.randint(0, n - 1)]  # random selection</span></span><br><span class="line">                    x = x[random.choices(<span class="built_in">range</span>(n), weights=w)[<span class="number">0</span>]]  <span class="comment"># weighted selection</span></span><br><span class="line">                <span class="keyword">elif</span> parent == <span class="string">&#x27;weighted&#x27;</span>:</span><br><span class="line">                    x = (x * w.reshape(n, <span class="number">1</span>)).<span class="built_in">sum</span>(<span class="number">0</span>) / w.<span class="built_in">sum</span>()  <span class="comment"># weighted combination</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Mutate</span></span><br><span class="line">                mp, s = <span class="number">0.8</span>, <span class="number">0.2</span>  <span class="comment"># mutation probability, sigma</span></span><br><span class="line">                npr = np.random</span><br><span class="line">                npr.seed(<span class="built_in">int</span>(time.time()))</span><br><span class="line">                g = np.array([x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> meta.values()])  <span class="comment"># gains 0-1</span></span><br><span class="line">                ng = <span class="built_in">len</span>(meta)</span><br><span class="line">                v = np.ones(ng)</span><br><span class="line">                <span class="keyword">while</span> <span class="built_in">all</span>(v == <span class="number">1</span>):  <span class="comment"># mutate until a change occurs (prevent duplicates)</span></span><br><span class="line">                    v = (g * (npr.random(ng) &lt; mp) * npr.randn(ng) * npr.random() * s + <span class="number">1</span>).clip(<span class="number">0.3</span>, <span class="number">3.0</span>)</span><br><span class="line">                <span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="built_in">enumerate</span>(hyp.keys()):  <span class="comment"># plt.hist(v.ravel(), 300)</span></span><br><span class="line">                    hyp[k] = <span class="built_in">float</span>(x[i + <span class="number">7</span>] * v[i])  <span class="comment"># mutate</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Constrain to limits</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> meta.items():</span><br><span class="line">                hyp[k] = <span class="built_in">max</span>(hyp[k], v[<span class="number">1</span>])  <span class="comment"># lower limit</span></span><br><span class="line">                hyp[k] = <span class="built_in">min</span>(hyp[k], v[<span class="number">2</span>])  <span class="comment"># upper limit</span></span><br><span class="line">                hyp[k] = <span class="built_in">round</span>(hyp[k], <span class="number">5</span>)  <span class="comment"># significant digits</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Train mutation</span></span><br><span class="line">            results = train(hyp.copy(), opt, device, wandb=wandb)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Write mutation results</span></span><br><span class="line">            print_mutation(hyp.copy(), results, yaml_file, opt.bucket)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Plot results</span></span><br><span class="line">        plot_evolution(yaml_file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Hyperparameter evolution complete. Best results saved as: <span class="subst">&#123;yaml_file&#125;</span>\n&#x27;</span></span><br><span class="line">              <span class="string">f&#x27;Command to train a new model with these hyperparameters: $ python train.py --hyp <span class="subst">&#123;yaml_file&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="yolov5s.yaml">yolov5s.yaml</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parameters</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">80</span>  <span class="comment"># number of classes</span></span><br><span class="line"><span class="attr">depth_multiple:</span> <span class="number">0.33</span>  <span class="comment"># model depth multiple 控制模型深度</span></span><br><span class="line"><span class="attr">width_multiple:</span> <span class="number">0.50</span>  <span class="comment"># layer channel multiple 控制模型宽度，卷积核数量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># anchors</span></span><br><span class="line"><span class="attr">anchors:</span></span><br><span class="line">  <span class="bullet">-</span> [<span class="number">10</span>,<span class="number">13</span>, <span class="number">16</span>,<span class="number">30</span>, <span class="number">33</span>,<span class="number">23</span>]  <span class="comment"># P3/8         P3,经过了8倍下采样</span></span><br><span class="line">  <span class="bullet">-</span> [<span class="number">30</span>,<span class="number">61</span>, <span class="number">62</span>,<span class="number">45</span>, <span class="number">59</span>,<span class="number">119</span>]  <span class="comment"># P4/16       P4,经过了16倍下采样</span></span><br><span class="line">  <span class="bullet">-</span> [<span class="number">116</span>,<span class="number">90</span>, <span class="number">156</span>,<span class="number">198</span>, <span class="number">373</span>,<span class="number">326</span>]  <span class="comment"># P5/32   P5,经过了32倍下采样</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YOLOv5 backbone</span></span><br><span class="line"><span class="attr">backbone:</span></span><br><span class="line">  <span class="comment"># [from, number, module, args]</span></span><br><span class="line">  <span class="comment"># from, 表示当前模块输入来自哪一层，-1代表来自上一次层</span></span><br><span class="line">  <span class="comment"># number，本模块重复次数</span></span><br><span class="line">  [[<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Focus</span>, [<span class="number">64</span>, <span class="number">3</span>]],  <span class="comment"># 0-P1/2</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">128</span>, <span class="number">3</span>, <span class="number">2</span>]],  <span class="comment"># 1-P2/4   128个卷积核，卷积核大小为3*3，步长为2</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">128</span>]], </span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">256</span>, <span class="number">3</span>, <span class="number">2</span>]],  <span class="comment"># 3-P3/8</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">9</span>, <span class="string">C3</span>, [<span class="number">256</span>]],</span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">512</span>, <span class="number">3</span>, <span class="number">2</span>]],  <span class="comment"># 5-P4/16</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">9</span>, <span class="string">C3</span>, [<span class="number">512</span>]],</span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">1024</span>, <span class="number">3</span>, <span class="number">2</span>]],  <span class="comment"># 7-P5/32</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">SPP</span>, [<span class="number">1024</span>, [<span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>]]],</span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">1024</span>, <span class="literal">False</span>]],  <span class="comment"># 9</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># YOLOv5 head</span></span><br><span class="line"><span class="comment"># head 部分包含了 PANet + Detect 部分</span></span><br><span class="line"><span class="attr">head:</span></span><br><span class="line">  [[<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>]],</span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">nn.Upsample</span>, [<span class="string">None</span>, <span class="number">2</span>, <span class="string">&#x27;nearest&#x27;</span>]],</span><br><span class="line">   [[<span class="number">-1</span>, <span class="number">6</span>], <span class="number">1</span>, <span class="string">Concat</span>, [<span class="number">1</span>]],  <span class="comment"># cat backbone P4</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">512</span>, <span class="literal">False</span>]],  <span class="comment"># 13</span></span><br><span class="line"></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>]],</span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">nn.Upsample</span>, [<span class="string">None</span>, <span class="number">2</span>, <span class="string">&#x27;nearest&#x27;</span>]],</span><br><span class="line">   [[<span class="number">-1</span>, <span class="number">4</span>], <span class="number">1</span>, <span class="string">Concat</span>, [<span class="number">1</span>]],  <span class="comment"># cat backbone P3</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">256</span>, <span class="literal">False</span>]],  <span class="comment"># 17 (P3/8-small)  </span></span><br><span class="line"></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">256</span>, <span class="number">3</span>, <span class="number">2</span>]],</span><br><span class="line">   [[<span class="number">-1</span>, <span class="number">14</span>], <span class="number">1</span>, <span class="string">Concat</span>, [<span class="number">1</span>]],  <span class="comment"># cat head P4</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">512</span>, <span class="literal">False</span>]],  <span class="comment"># 20 (P4/16-medium)</span></span><br><span class="line"></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">1</span>, <span class="string">Conv</span>, [<span class="number">512</span>, <span class="number">3</span>, <span class="number">2</span>]],</span><br><span class="line">   [[<span class="number">-1</span>, <span class="number">10</span>], <span class="number">1</span>, <span class="string">Concat</span>, [<span class="number">1</span>]],  <span class="comment"># cat head P5</span></span><br><span class="line">   [<span class="number">-1</span>, <span class="number">3</span>, <span class="string">C3</span>, [<span class="number">1024</span>, <span class="literal">False</span>]],  <span class="comment"># 23 (P5/32-large)</span></span><br><span class="line"></span><br><span class="line">   [[<span class="number">17</span>, <span class="number">20</span>, <span class="number">23</span>], <span class="number">1</span>, <span class="string">Detect</span>, [<span class="string">nc</span>, <span class="string">anchors</span>]],  <span class="comment"># Detect(P3, P4, P5)</span></span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/YOLO-V5-4-0/" rel="tag"># YOLO V5-4.0</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/cpp/c-primer-v5-solutions/" rel="prev" title="c++ primer v5 solutions">
      <i class="fa fa-chevron-left"></i> c++ primer v5 solutions
    </a></div>
      <div class="post-nav-item">
    <a href="/Python/Python-%E7%B3%BB%E5%88%97%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/" rel="next" title="Python 系列模块介绍">
      Python 系列模块介绍 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#detect.py"><span class="nav-text">detect.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#test.py"><span class="nav-text">test.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#train.py"><span class="nav-text">train.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yolov5s.yaml"><span class="nav-text">yolov5s.yaml</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="TLDX"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">TLDX</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/TLDX-XIONG" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;TLDX-XIONG" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2029949969@qq.com" title="E-Mail → mailto:2029949969@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TLDX All Rights Reserved</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">89k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">1:21</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '8UBNFxmQcjGjVE43FUfTiJpd-gzGzoHsz',
      appKey     : 'iREWYRy3HYdwh6ICCVsB1OQB',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
